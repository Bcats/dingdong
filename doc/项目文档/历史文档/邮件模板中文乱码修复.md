# é‚®ä»¶æ¨¡æ¿ä¸­æ–‡ä¹±ç ä¿®å¤è®°å½•

**æ—¥æœŸ**: 2025-10-25  
**é—®é¢˜**: é‚®ä»¶æ¨¡æ¿ä¸­æ–‡æ˜¾ç¤ºä¸ºä¹±ç ï¼ˆ????ï¼‰  
**çŠ¶æ€**: âœ… å·²è§£å†³

---

## ğŸ“‹ é—®é¢˜æè¿°

ç”¨æˆ·æ”¶åˆ°çš„æµ‹è¯•é‚®ä»¶ä¸­ï¼Œæ ‡é¢˜å’Œå†…å®¹çš„ä¸­æ–‡å…¨éƒ¨æ˜¾ç¤ºä¸ºé—®å·ï¼š

```
é‚®ä»¶æ ‡é¢˜ï¼š???????? - 2025-10-25 17:05:00
é‚®ä»¶å†…å®¹ï¼š
??!
??????????????????

????:2025-10-25 17:05:00

?????????,????????!
```

---

## ğŸ” é—®é¢˜åˆ†æ

### æ•°æ®åº“æŸ¥è¯¢ç»“æœ

```sql
SELECT id, code, name, subject_template, content_template 
FROM message_templates 
WHERE code='test_email';
```

**ç»“æœ**:
```
name: ????
subject_template: ???????? - {{timestamp}}
content_template: <html><body><h1>??!</h1>...
```

### æ ¹æœ¬åŸå› 

é‚®ä»¶æ¨¡æ¿åœ¨æ’å…¥æ•°æ®åº“æ—¶ï¼Œ**å­—ç¬¦ç¼–ç å¤„ç†ä¸æ­£ç¡®**ï¼Œå¯¼è‡´ä¸­æ–‡å­—ç¬¦è¢«é”™è¯¯å­˜å‚¨ä¸ºä¹±ç ã€‚

å¯èƒ½åŸå› ï¼š
1. æ•°æ®åº“å®¢æˆ·ç«¯ç¼–ç è®¾ç½®ä¸æ­£ç¡®
2. æ’å…¥æ—¶æœªæŒ‡å®šUTF-8ç¼–ç 
3. PostgreSQLè¿æ¥å­—ç¬¦é›†é…ç½®é—®é¢˜

---

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### ä¿®å¤æ­¥éª¤

1. **åˆ›å»ºSQLä¿®å¤è„šæœ¬**

```sql
-- fix_template.sql
UPDATE message_templates 
SET 
  name = 'æµ‹è¯•é‚®ä»¶',
  subject_template = 'ã€æµ‹è¯•ã€‘ç³»ç»Ÿé€šçŸ¥ - {{timestamp}}',
  content_template = '<html><body><h1>ä½ å¥½!</h1><p>è¿™æ˜¯ä¸€å°æ¥è‡ªæ¶ˆæ¯é€šçŸ¥å¹³å°çš„æµ‹è¯•é‚®ä»¶ã€‚</p><p>æ—¶é—´æˆ³:{{timestamp}}</p><p>å¦‚æœä½ æ”¶åˆ°è¿™å°é‚®ä»¶,è¯´æ˜ç³»ç»Ÿè¿è¡Œæ­£å¸¸!</p></body></html>'
WHERE code = 'test_email';
```

2. **æ‰§è¡Œä¿®å¤**

```bash
# å¤åˆ¶SQLæ–‡ä»¶åˆ°å®¹å™¨
docker cp fix_template.sql notification-db:/tmp/fix_template.sql

# æ‰§è¡ŒSQLè„šæœ¬
docker-compose exec -T postgres psql -U notification_user -d notification_db -f /tmp/fix_template.sql
```

3. **éªŒè¯ä¿®å¤**

```sql
SELECT id, code, name, subject_template 
FROM message_templates 
WHERE code='test_email';
```

**ç»“æœ**: âœ… ä¸­æ–‡æ˜¾ç¤ºæ­£å¸¸
```
id: 1
code: test_email
name: æµ‹è¯•é‚®ä»¶
subject_template: ã€æµ‹è¯•ã€‘ç³»ç»Ÿé€šçŸ¥ - {{timestamp}}
```

---

## âœ… æµ‹è¯•éªŒè¯

### å‘é€æ–°é‚®ä»¶

**APIè°ƒç”¨**:
```json
POST /api/v1/messages/email/send
{
  "to": ["205672513@qq.com"],
  "template_code": "test_email",
  "template_variables": {
    "timestamp": "2025-10-25 17:10:00"
  }
}
```

**å“åº”**:
```json
{
  "code": 0,
  "message": "Message queued for sending",
  "data": {
    "message_id": 5,
    "status": "pending"
  }
}
```

### å‘é€ç»“æœ

**Celery Workeræ—¥å¿—**:
```
[2025-10-25 17:09:19] INFO | Email sent successfully to ['205672513@qq.com']
[2025-10-25 17:09:19] INFO | Updated message 5 status to success
[2025-10-25 17:09:19] INFO | Task succeeded in 0.84s
```

**çŠ¶æ€**: âœ… å‘é€æˆåŠŸ

---

## ğŸ“§ é¢„æœŸé‚®ä»¶å†…å®¹

ä¿®å¤åï¼Œç”¨æˆ·åº”è¯¥æ”¶åˆ°ä»¥ä¸‹å†…å®¹ï¼š

**é‚®ä»¶æ ‡é¢˜**:
```
ã€æµ‹è¯•ã€‘ç³»ç»Ÿé€šçŸ¥ - 2025-10-25 17:10:00
```

**é‚®ä»¶æ­£æ–‡**:
```
ä½ å¥½!

è¿™æ˜¯ä¸€å°æ¥è‡ªæ¶ˆæ¯é€šçŸ¥å¹³å°çš„æµ‹è¯•é‚®ä»¶ã€‚

æ—¶é—´æˆ³:2025-10-25 17:10:00

å¦‚æœä½ æ”¶åˆ°è¿™å°é‚®ä»¶,è¯´æ˜ç³»ç»Ÿè¿è¡Œæ­£å¸¸!
```

---

## ğŸ¯ é¢„é˜²æªæ–½

### 1. ç¡®ä¿æ•°æ®åº“å­—ç¬¦é›†é…ç½®

æ£€æŸ¥PostgreSQLé…ç½®ï¼š
```sql
-- æŸ¥çœ‹æ•°æ®åº“ç¼–ç 
SELECT datname, pg_encoding_to_char(encoding) FROM pg_database;

-- åº”è¯¥æ˜¾ç¤º UTF8
```

### 2. ä½¿ç”¨æ­£ç¡®çš„è¿æ¥å­—ç¬¦ä¸²

```python
DATABASE_URL = "postgresql://user:pass@host:port/db?client_encoding=utf8"
```

### 3. APIæ¥å£æ·»åŠ å­—ç¬¦ç¼–ç å¤„ç†

åˆ›å»ºæ¨¡æ¿æ—¶ç¡®ä¿ï¼š
```python
@router.post("/templates")
async def create_template(template: TemplateCreate):
    # ç¡®ä¿å­—ç¬¦ä¸²æ˜¯UTF-8ç¼–ç 
    template.name = template.name.encode('utf-8').decode('utf-8')
    template.subject_template = template.subject_template.encode('utf-8').decode('utf-8')
    template.content_template = template.content_template.encode('utf-8').decode('utf-8')
    # ...
```

### 4. æµ‹è¯•æ¨¡æ¿åˆ›å»º

å»ºè®®åœ¨åˆ›å»ºæ¨¡æ¿åç«‹å³æµ‹è¯•ï¼š
```bash
# åˆ›å»ºæ¨¡æ¿
curl -X POST /api/v1/templates

# ç«‹å³æŸ¥è¯¢éªŒè¯
curl -X GET /api/v1/templates/{id}

# å‘é€æµ‹è¯•é‚®ä»¶
curl -X POST /api/v1/messages/email/send
```

---

## ğŸ“Š ç›¸å…³æ•°æ®

### é‚®ä»¶å‘é€è®°å½•

| message_id | status | to | subject |
|------------|--------|-----|---------|
| 4 | success | 205672513@qq.com | ???????? - ... (ä¹±ç ) |
| 5 | success | 205672513@qq.com | ã€æµ‹è¯•ã€‘ç³»ç»Ÿé€šçŸ¥ - ... âœ… (æ­£å¸¸) |

---

## ğŸ“ ç»éªŒæ€»ç»“

### é—®é¢˜æ•™è®­

1. **å­—ç¬¦ç¼–ç å¾ˆé‡è¦** - åœ¨å¤„ç†å¤šè¯­è¨€å†…å®¹æ—¶å¿…é¡»ç‰¹åˆ«æ³¨æ„
2. **æ—©æœŸæµ‹è¯•** - åˆ›å»ºæ¨¡æ¿ååº”è¯¥ç«‹å³å‘é€æµ‹è¯•é‚®ä»¶éªŒè¯
3. **æ•°æ®éªŒè¯** - å…¥åº“å‰åº”è¯¥éªŒè¯æ•°æ®çš„æ­£ç¡®æ€§

### æœ€ä½³å®è·µ

1. âœ… ç»Ÿä¸€ä½¿ç”¨UTF-8ç¼–ç 
2. âœ… åœ¨APIå±‚é¢è¿›è¡Œå­—ç¬¦ç¼–ç éªŒè¯
3. âœ… æä¾›æ¨¡æ¿é¢„è§ˆåŠŸèƒ½
4. âœ… å¢åŠ æ¨¡æ¿å†…å®¹çš„å•å…ƒæµ‹è¯•
5. âœ… å®šæœŸæ£€æŸ¥æ•°æ®åº“å†…å®¹çš„å®Œæ•´æ€§

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [PostgreSQLå­—ç¬¦é›†è®¾ç½®](https://www.postgresql.org/docs/current/multibyte.html)
- [Python Unicodeå¤„ç†](https://docs.python.org/3/howto/unicode.html)
- [é‚®ä»¶å‘é€åŠŸèƒ½è°ƒè¯•æŠ¥å‘Š](./é‚®ä»¶å‘é€åŠŸèƒ½è°ƒè¯•æŠ¥å‘Š.md)

---

**ä¿®å¤äºº**: AI Assistant  
**å®Œæˆæ—¶é—´**: 2025-10-25 17:10  
**éªŒè¯çŠ¶æ€**: âœ… å·²å‘é€æ–°é‚®ä»¶ï¼Œç­‰å¾…ç”¨æˆ·ç¡®è®¤

