# 邮件模板中文乱码修复记录

**日期**: 2025-10-25  
**问题**: 邮件模板中文显示为乱码（????）  
**状态**: ✅ 已解决

---

## 📋 问题描述

用户收到的测试邮件中，标题和内容的中文全部显示为问号：

```
邮件标题：???????? - 2025-10-25 17:05:00
邮件内容：
??!
??????????????????

????:2025-10-25 17:05:00

?????????,????????!
```

---

## 🔍 问题分析

### 数据库查询结果

```sql
SELECT id, code, name, subject_template, content_template 
FROM message_templates 
WHERE code='test_email';
```

**结果**:
```
name: ????
subject_template: ???????? - {{timestamp}}
content_template: <html><body><h1>??!</h1>...
```

### 根本原因

邮件模板在插入数据库时，**字符编码处理不正确**，导致中文字符被错误存储为乱码。

可能原因：
1. 数据库客户端编码设置不正确
2. 插入时未指定UTF-8编码
3. PostgreSQL连接字符集配置问题

---

## 🛠️ 解决方案

### 修复步骤

1. **创建SQL修复脚本**

```sql
-- fix_template.sql
UPDATE message_templates 
SET 
  name = '测试邮件',
  subject_template = '【测试】系统通知 - {{timestamp}}',
  content_template = '<html><body><h1>你好!</h1><p>这是一封来自消息通知平台的测试邮件。</p><p>时间戳:{{timestamp}}</p><p>如果你收到这封邮件,说明系统运行正常!</p></body></html>'
WHERE code = 'test_email';
```

2. **执行修复**

```bash
# 复制SQL文件到容器
docker cp fix_template.sql notification-db:/tmp/fix_template.sql

# 执行SQL脚本
docker-compose exec -T postgres psql -U notification_user -d notification_db -f /tmp/fix_template.sql
```

3. **验证修复**

```sql
SELECT id, code, name, subject_template 
FROM message_templates 
WHERE code='test_email';
```

**结果**: ✅ 中文显示正常
```
id: 1
code: test_email
name: 测试邮件
subject_template: 【测试】系统通知 - {{timestamp}}
```

---

## ✅ 测试验证

### 发送新邮件

**API调用**:
```json
POST /api/v1/messages/email/send
{
  "to": ["205672513@qq.com"],
  "template_code": "test_email",
  "template_variables": {
    "timestamp": "2025-10-25 17:10:00"
  }
}
```

**响应**:
```json
{
  "code": 0,
  "message": "Message queued for sending",
  "data": {
    "message_id": 5,
    "status": "pending"
  }
}
```

### 发送结果

**Celery Worker日志**:
```
[2025-10-25 17:09:19] INFO | Email sent successfully to ['205672513@qq.com']
[2025-10-25 17:09:19] INFO | Updated message 5 status to success
[2025-10-25 17:09:19] INFO | Task succeeded in 0.84s
```

**状态**: ✅ 发送成功

---

## 📧 预期邮件内容

修复后，用户应该收到以下内容：

**邮件标题**:
```
【测试】系统通知 - 2025-10-25 17:10:00
```

**邮件正文**:
```
你好!

这是一封来自消息通知平台的测试邮件。

时间戳:2025-10-25 17:10:00

如果你收到这封邮件,说明系统运行正常!
```

---

## 🎯 预防措施

### 1. 确保数据库字符集配置

检查PostgreSQL配置：
```sql
-- 查看数据库编码
SELECT datname, pg_encoding_to_char(encoding) FROM pg_database;

-- 应该显示 UTF8
```

### 2. 使用正确的连接字符串

```python
DATABASE_URL = "postgresql://user:pass@host:port/db?client_encoding=utf8"
```

### 3. API接口添加字符编码处理

创建模板时确保：
```python
@router.post("/templates")
async def create_template(template: TemplateCreate):
    # 确保字符串是UTF-8编码
    template.name = template.name.encode('utf-8').decode('utf-8')
    template.subject_template = template.subject_template.encode('utf-8').decode('utf-8')
    template.content_template = template.content_template.encode('utf-8').decode('utf-8')
    # ...
```

### 4. 测试模板创建

建议在创建模板后立即测试：
```bash
# 创建模板
curl -X POST /api/v1/templates

# 立即查询验证
curl -X GET /api/v1/templates/{id}

# 发送测试邮件
curl -X POST /api/v1/messages/email/send
```

---

## 📊 相关数据

### 邮件发送记录

| message_id | status | to | subject |
|------------|--------|-----|---------|
| 4 | success | 205672513@qq.com | ???????? - ... (乱码) |
| 5 | success | 205672513@qq.com | 【测试】系统通知 - ... ✅ (正常) |

---

## 📝 经验总结

### 问题教训

1. **字符编码很重要** - 在处理多语言内容时必须特别注意
2. **早期测试** - 创建模板后应该立即发送测试邮件验证
3. **数据验证** - 入库前应该验证数据的正确性

### 最佳实践

1. ✅ 统一使用UTF-8编码
2. ✅ 在API层面进行字符编码验证
3. ✅ 提供模板预览功能
4. ✅ 增加模板内容的单元测试
5. ✅ 定期检查数据库内容的完整性

---

## 🔗 相关文档

- [PostgreSQL字符集设置](https://www.postgresql.org/docs/current/multibyte.html)
- [Python Unicode处理](https://docs.python.org/3/howto/unicode.html)
- [邮件发送功能调试报告](./邮件发送功能调试报告.md)

---

**修复人**: AI Assistant  
**完成时间**: 2025-10-25 17:10  
**验证状态**: ✅ 已发送新邮件，等待用户确认

