# é‚®ä»¶å‘é€åŠŸèƒ½è°ƒè¯•æŠ¥å‘Š

**æ—¥æœŸ**: 2025-10-25  
**çŠ¶æ€**: âœ… å·²è§£å†³  
**å·¥ç¨‹å¸ˆ**: AI Assistant

---

## ğŸ“‹ é—®é¢˜æ‘˜è¦

é‚®ä»¶å‘é€åŠŸèƒ½å¤±è´¥ï¼ŒQQé‚®ç®±SMTPè¿æ¥æŠ¥é”™ï¼š
- é”™è¯¯1: `Error connecting to smtp.qq.com on port 465: Unexpected EOF received`
- é”™è¯¯2: `(502, 'Invalid paramenters', '')`
- ç»“æœ: é‚®ä»¶è´¦æˆ·è¢«è‡ªåŠ¨ç¦ç”¨ï¼ˆfailure_countè¾¾åˆ°ä¸Šé™ï¼‰

---

## ğŸ” é—®é¢˜åˆ†æ

### æ ¹æœ¬åŸå› 

1. **æ•°æ®åº“é…ç½®é”™è¯¯**
   - `use_tls` å­—æ®µè¢«é”™è¯¯è®¾ç½®ä¸º `false`
   - 465ç«¯å£éœ€è¦SSL/TLSè¿æ¥

2. **SMTPè¿æ¥å‚æ•°ç¼ºå¤±**
   - ä»£ç ä¸­ç¼ºå°‘ `start_tls=False` å‚æ•°
   - QQé‚®ç®±465ç«¯å£ä½¿ç”¨ implicit SSLï¼Œä¸éœ€è¦STARTTLS

3. **Fromå­—æ®µæ ¼å¼é—®é¢˜**
   - ä½¿ç”¨äº† `"æ˜¾ç¤ºåç§° <email@qq.com>"` æ ¼å¼
   - QQé‚®ç®±è¦æ±‚ä¸¥æ ¼éµå®ˆRFC5322æ ‡å‡†
   - å¤æ‚æ ¼å¼è¢«æ‹’ç»ï¼Œéœ€è¦ç®€åŒ–ä¸ºçº¯é‚®ç®±åœ°å€

---

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### 1. ä¿®å¤æ•°æ®åº“é…ç½®

```sql
UPDATE email_accounts 
SET use_tls = true, failure_count = 0 
WHERE id = 1;
```

**ç»“æœ**: 
- âœ… TLSå·²å¯ç”¨
- âœ… å¤±è´¥è®¡æ•°å·²é‡ç½®

### 2. ä¿®å¤SMTPè¿æ¥å‚æ•°

**æ–‡ä»¶**: `app/services/email_service.py`

**ä¿®æ”¹å‰**:
```python
async with aiosmtplib.SMTP(
    hostname=self.account.smtp_host,
    port=self.account.smtp_port,
    use_tls=self.account.use_tls,
    timeout=settings.EMAIL_TIMEOUT
) as smtp:
```

**ä¿®æ”¹å**:
```python
async with aiosmtplib.SMTP(
    hostname=self.account.smtp_host,
    port=self.account.smtp_port,
    use_tls=self.account.use_tls,
    start_tls=False,  # 465ç«¯å£ä½¿ç”¨implicit SSLï¼Œä¸éœ€è¦STARTTLS
    timeout=settings.EMAIL_TIMEOUT
) as smtp:
```

**è¯´æ˜**:
- QQé‚®ç®±465ç«¯å£ä½¿ç”¨ implicit SSLï¼ˆSSL/TLSï¼‰
- 587ç«¯å£æ‰ä½¿ç”¨ explicit TLSï¼ˆSTARTTLSï¼‰
- è®¾ç½® `start_tls=False` é¿å…å°è¯•STARTTLSæ¡æ‰‹

### 3. ç®€åŒ–Fromå­—æ®µæ ¼å¼

**æ–‡ä»¶**: `app/services/email_service.py`

**ä¿®æ”¹å‰**:
```python
message["From"] = f"{self.account.display_name or self.account.email} <{self.account.email}>"
```

**ä¿®æ”¹å**:
```python
# QQé‚®ç®±å¯¹Fromå­—æ®µæ ¼å¼è¦æ±‚ä¸¥æ ¼ï¼Œç®€åŒ–ä¸ºåªä½¿ç”¨é‚®ç®±åœ°å€
message["From"] = self.account.email
```

**è¯´æ˜**:
- QQé‚®ç®±ä¸¥æ ¼æ£€æŸ¥Fromå­—æ®µæ ¼å¼
- å¤æ‚æ ¼å¼ï¼ˆå¦‚"åç§° <é‚®ç®±>"ï¼‰å¯èƒ½è¢«æ‹’ç»
- ä½¿ç”¨çº¯é‚®ç®±åœ°å€æœ€ç¨³å®šå¯é 

---

## âœ… æµ‹è¯•ç»“æœ

### æµ‹è¯•1: SMTPè¿æ¥æµ‹è¯•

**æµ‹è¯•è„šæœ¬**: `test_smtp.py`

```
æ–¹å¼1: use_tls=True
  âœ“ è¿æ¥æˆåŠŸ
  âœ“ ç™»å½•æˆåŠŸ
  âœ— æ–¹å¼1å¤±è´¥: (550, 'The "From" header is missing or invalid...')

æ–¹å¼2: start_tls=False, use_tls=True
  âœ“ è¿æ¥æˆåŠŸ
  âœ“ ç™»å½•æˆåŠŸ
  âœ“ é‚®ä»¶å‘é€æˆåŠŸ
```

### æµ‹è¯•2: å®é™…é‚®ä»¶å‘é€

**APIè°ƒç”¨**:
```json
POST /api/v1/messages/email/send
{
  "to": ["205672513@qq.com"],
  "template_code": "test_email",
  "template_variables": {
    "timestamp": "2025-10-25 17:05:00"
  }
}
```

**å“åº”**:
```json
{
  "code": 0,
  "message": "Message queued for sending",
  "data": {
    "message_id": 4,
    "status": "pending",
    "request_id": "23e10cbd-5fd5-48dc-a242-ba3aa6a94672"
  }
}
```

**Celery Workeræ—¥å¿—**:
```
[2025-10-25 17:04:22] INFO | Email sent successfully to ['205672513@qq.com'] from 1905985427@qq.com
[2025-10-25 17:04:22] INFO | Updated message 4 status to success
[2025-10-25 17:04:22] INFO | Task succeeded in 0.95s
```

**ç»“æœ**: âœ… **é‚®ä»¶å‘é€æˆåŠŸï¼**

---

## ğŸ“Š æ•°æ®åº“çŠ¶æ€

### é‚®ç®±è´¦æˆ·çŠ¶æ€ï¼ˆä¿®å¤åï¼‰

```
id: 1
email: 1905985427@qq.com
smtp_host: smtp.qq.com
smtp_port: 465
use_tls: true âœ…
is_active: true âœ…
failure_count: 0 âœ…
```

### æ¶ˆæ¯è®°å½•

```
message_id: 4
status: success âœ…
channel: email
to: 205672513@qq.com
subject: ã€æµ‹è¯•ã€‘ç³»ç»Ÿé€šçŸ¥ - 2025-10-25 17:05:00
error_message: null
retry_count: 0
```

---

## ğŸ“ å…³é”®è¦ç‚¹

### QQé‚®ç®±SMTPé…ç½®

| é…ç½®é¡¹ | ç«¯å£465 | ç«¯å£587 |
|-------|---------|---------|
| åè®® | SSL/TLS (implicit) | STARTTLS (explicit) |
| `use_tls` | true | true |
| `start_tls` | false | true |
| Fromæ ¼å¼ | çº¯é‚®ç®±åœ°å€ï¼ˆæ¨èï¼‰ | çº¯é‚®ç®±åœ°å€ï¼ˆæ¨èï¼‰ |

### aiosmtplib å‚æ•°è¯´æ˜

- **use_tls**: æ˜¯å¦ä½¿ç”¨TLS/SSLè¿æ¥
  - `True`: åœ¨è¿æ¥å»ºç«‹æ—¶å°±ä½¿ç”¨SSL/TLSï¼ˆç”¨äº465ç«¯å£ï¼‰
  - `False`: ä¸ä½¿ç”¨SSL/TLS
  
- **start_tls**: æ˜¯å¦åœ¨è¿æ¥åä½¿ç”¨STARTTLSå‡çº§
  - `True`: ä½¿ç”¨STARTTLSå‘½ä»¤å‡çº§ä¸ºTLSï¼ˆç”¨äº587ç«¯å£ï¼‰
  - `False`: ä¸ä½¿ç”¨STARTTLSï¼ˆç”¨äº465ç«¯å£ï¼‰

### QQé‚®ç®±Fromå­—æ®µè¦æ±‚

- âœ… **æ¨è**: `user@qq.com`
- âš ï¸ **è°¨æ…**: `"ç”¨æˆ·å" <user@qq.com>`
- âŒ **é¿å…**: `ç”¨æˆ·å <user@qq.com>` (ç¼ºå°‘å¼•å·)

---

## ğŸ¯ åç»­å»ºè®®

### 1. ç›‘æ§ä¸æ—¥å¿—

- âœ… é‚®ä»¶å‘é€æˆåŠŸç‡
- âœ… SMTPé”™è¯¯ç±»å‹ç»Ÿè®¡
- âœ… è´¦æˆ·å¤±è´¥è®¡æ•°é¢„è­¦

### 2. é…ç½®ä¼˜åŒ–

è€ƒè™‘æ”¯æŒå¤šç§SMTPç«¯å£é…ç½®ï¼š
```python
SMTP_CONFIGS = {
    465: {"use_tls": True, "start_tls": False},   # SSL/TLS
    587: {"use_tls": True, "start_tls": True},    # STARTTLS
    25: {"use_tls": False, "start_tls": True},    # STARTTLS
}
```

### 3. é”™è¯¯å¤„ç†

- åŒºåˆ†ä¸åŒç±»å‹çš„SMTPé”™è¯¯
- é’ˆå¯¹æ€§é‡è¯•ç­–ç•¥
- è‡ªåŠ¨åˆ‡æ¢å¤‡ç”¨è´¦æˆ·

### 4. Fromå­—æ®µå¤„ç†

å¦‚éœ€æ”¯æŒæ˜¾ç¤ºåç§°ï¼Œå¯ä»¥ï¼š
- ä½¿ç”¨Python `email.utils.formataddr()` å‡½æ•°
- ä¸¥æ ¼éµå¾ªRFC5322æ ‡å‡†æ ¼å¼åŒ–
- é’ˆå¯¹ä¸åŒé‚®ä»¶æœåŠ¡å•†ä½¿ç”¨ä¸åŒç­–ç•¥

```python
from email.utils import formataddr

# æ ‡å‡†æ ¼å¼åŒ–
message["From"] = formataddr((display_name, email))
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [QQé‚®ç®±SMTPè®¾ç½®æŒ‡å—](https://service.mail.qq.com/detail/0/75)
- [RFC5322 - Internet Message Format](https://tools.ietf.org/html/rfc5322)
- [aiosmtplibæ–‡æ¡£](https://aiosmtplib.readthedocs.io/)
- [Python emailæ¨¡å—æ–‡æ¡£](https://docs.python.org/3/library/email.html)

---

## ğŸ ç»“è®º

**é—®é¢˜å·²å®Œå…¨è§£å†³ï¼** âœ…

ä¿®å¤è¦ç‚¹ï¼š
1. âœ… å¯ç”¨TLSé…ç½®
2. âœ… æ·»åŠ  `start_tls=False` å‚æ•°
3. âœ… ç®€åŒ–Fromå­—æ®µæ ¼å¼
4. âœ… é‡ç½®å¤±è´¥è®¡æ•°

**æµ‹è¯•ç»“æœ**: é‚®ä»¶æˆåŠŸå‘é€åˆ° 205672513@qq.com

**ä»£ç æäº¤**: å»ºè®®æäº¤ä»¥ä¸‹æ–‡ä»¶
- `app/services/email_service.py`

---

**æŠ¥å‘Šäºº**: AI Assistant  
**å®Œæˆæ—¶é—´**: 2025-10-25 17:05  
**ä¸‹ä¸€æ­¥**: ç­‰å¾…ç”¨æˆ·ç¡®è®¤æ”¶åˆ°æµ‹è¯•é‚®ä»¶

