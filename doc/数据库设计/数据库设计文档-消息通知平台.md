# 数据库设计文档 - 消息通知平台

**版本**：v1.0  
**日期**：2025-10-24  
**数据库**：PostgreSQL 14+  
**字符集**：UTF-8  
**参考标准**：阿里巴巴数据库设计规范

---

## 目录

1. [设计原则](#一设计原则)
2. [数据库概览](#二数据库概览)
3. [表设计详情](#三表设计详情)
4. [索引设计](#四索引设计)
5. [ER图说明](#五er图说明)
6. [初始化脚本](#六初始化脚本)
7. [数据字典](#七数据字典)

---

## 一、设计原则

### 1.1 命名规范

#### 【强制】表名、字段名必须使用小写字母或数字，禁止出现数字开头

**说明**：MySQL在Windows下不区分大小写，但在Linux下默认区分大小写。为保证可移植性，统一使用小写。

**正例**：`message_records`, `email_accounts`  
**反例**：`MessageRecords`, `1_email_accounts`

#### 【强制】表名不使用复数名词

**说明**：虽然本项目根据实际情况使用了复数（如message_records），但这是为了更清晰地表达"记录集合"的含义。

#### 【强制】禁用保留字

**说明**：避免使用MySQL/PostgreSQL保留字，如`order`, `match`, `user`, `key`等。

#### 【强制】主键索引名为`pk_字段名`；唯一索引名为`uk_字段名`；普通索引名为`idx_字段名`

**正例**：
- 主键索引：`pk_id`
- 唯一索引：`uk_message_id`, `uk_email`
- 普通索引：`idx_status`, `idx_created_at`

#### 【强制】小数类型为decimal，禁止使用float和double

**说明**：float和double存在精度损失问题，decimal不会有精度损失。

#### 【强制】varchar字段必须指定长度

**说明**：varchar是变长字符串，不指定长度会导致不必要的空间浪费。

**正例**：`VARCHAR(255)`, `VARCHAR(64)`

### 1.2 设计规范

#### 【强制】表必备三字段：id, created_at, updated_at

**说明**：
- `id`：主键，类型为BIGINT UNSIGNED，自增
- `created_at`：创建时间，类型为TIMESTAMP，默认CURRENT_TIMESTAMP
- `updated_at`：更新时间，类型为TIMESTAMP，默认CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP

#### 【强制】表的命名最好是加上"业务名称_表名称"

**说明**：本项目所有表都属于notification业务，可省略前缀。

#### 【强制】字段允许适当冗余，以提高查询性能，但必须考虑数据一致性

**说明**：如在message_records表中冗余template_name字段（虽然可以通过template_id关联查询）。

#### 【推荐】单表行数超过500万行或者单表容量超过2GB，才推荐进行分库分表

**说明**：如果预计三年后的数据量根本达不到这个级别，可以不用考虑分库分表。

#### 【推荐】合适的字符存储长度，不但节约数据库表空间、节约索引存储，更重要的是提升检索速度

**正例**：
- IP地址：`VARCHAR(15)`（xxx.xxx.xxx.xxx）
- 邮箱地址：`VARCHAR(255)`
- 手机号：`VARCHAR(20)`
- 状态字段：`VARCHAR(20)`

---

## 二、数据库概览

### 2.1 数据库信息

| 属性 | 值 |
|------|------|
| 数据库名称 | `notification_db` |
| 字符集 | `UTF8` |
| 排序规则 | `zh_CN.UTF-8` |
| 数据库版本 | PostgreSQL 14+ |

### 2.2 表清单

**第一期（MVP）表**：

| 序号 | 表名 | 中文名 | 说明 | 行数预估 |
|------|------|------|------|---------|
| 1 | message_records | 消息记录表 | 存储所有消息发送记录 | 100万/年 |
| 2 | message_templates | 消息模板表 | 存储消息模板 | < 100 |
| 3 | message_template_history | 模板历史表 | 存储模板历史版本 | < 500 |
| 4 | email_accounts | 邮箱账户表 | 存储邮箱池账户信息 | < 50 |
| 5 | email_attachments | 邮件附件表 | 存储附件元信息 | 50万/年 |
| 6 | api_keys | API密钥表 | 存储API认证密钥 | < 100 |

**第二期待添加表**：
- `sms_configs`：短信配置表
- `sms_templates`：短信模板表
- `wechat_configs`：微信配置表
- `scheduled_tasks`：定时任务表
- `tenants`：租户表
- `webhook_configs`：Webhook配置表

### 2.3 存储空间预估

**第一年数据量预估**：

| 表名 | 单条记录大小 | 年增长量 | 存储空间 |
|------|-------------|---------|----------|
| message_records | ~2KB | 100万 | ~2GB |
| email_attachments | ~500B | 50万 | ~250MB |
| 其他表 | - | - | < 10MB |
| **合计** | - | - | **~2.3GB** |

**说明**：第一年数据量预估约2.3GB，远未达到分表阈值（2GB/表或500万行）。

---

## 三、表设计详情

### 3.1 消息记录表 (message_records)

**表说明**：存储所有消息发送记录，包括邮件、短信、微信等（第一期仅邮件）。

**存储引擎**：InnoDB（PostgreSQL无此概念）  
**字符集**：UTF8  
**预估行数**：100万/年

#### 表结构

```sql
CREATE TABLE message_records (
    -- 主键
    id BIGSERIAL PRIMARY KEY,
    
    -- 业务字段
    message_id VARCHAR(64) UNIQUE NOT NULL,
    message_type VARCHAR(20) NOT NULL DEFAULT 'email',
    template_id BIGINT,
    template_version INT,
    recipient VARCHAR(255) NOT NULL,
    subject VARCHAR(255),
    content TEXT,
    template_vars JSONB,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    retry_count INT DEFAULT 0,
    error_message TEXT,
    retry_logs JSONB,
    sender_info JSONB,
    idempotency_key VARCHAR(128),
    request_id VARCHAR(64),
    
    -- 审计字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    sent_at TIMESTAMP,
    
    -- 索引
    CONSTRAINT pk_message_records PRIMARY KEY (id),
    CONSTRAINT uk_message_id UNIQUE (message_id),
    CONSTRAINT fk_template FOREIGN KEY (template_id) 
        REFERENCES message_templates(id) ON DELETE SET NULL
);

-- 创建索引
CREATE INDEX idx_message_id ON message_records(message_id);
CREATE INDEX idx_recipient ON message_records(recipient);
CREATE INDEX idx_status ON message_records(status);
CREATE INDEX idx_created_at ON message_records(created_at);
CREATE INDEX idx_idempotency_key ON message_records(idempotency_key);
CREATE INDEX idx_request_id ON message_records(request_id);

-- 添加字段注释
COMMENT ON TABLE message_records IS '消息发送记录表';
COMMENT ON COLUMN message_records.message_id IS '消息唯一ID，格式: msg_{timestamp}_{random}';
COMMENT ON COLUMN message_records.message_type IS '消息类型: email/sms/wechat';
COMMENT ON COLUMN message_records.template_id IS '使用的模板ID';
COMMENT ON COLUMN message_records.template_version IS '使用的模板版本号';
COMMENT ON COLUMN message_records.recipient IS '接收人（邮箱地址/手机号/微信ID）';
COMMENT ON COLUMN message_records.subject IS '邮件主题';
COMMENT ON COLUMN message_records.content IS '消息内容（渲染后的完整内容）';
COMMENT ON COLUMN message_records.template_vars IS '模板变量，JSON格式';
COMMENT ON COLUMN message_records.status IS '发送状态: pending/sending/success/failed';
COMMENT ON COLUMN message_records.retry_count IS '重试次数';
COMMENT ON COLUMN message_records.error_message IS '错误信息';
COMMENT ON COLUMN message_records.retry_logs IS '重试日志，JSON数组格式';
COMMENT ON COLUMN message_records.sender_info IS '发送者信息，如邮箱账户ID等';
COMMENT ON COLUMN message_records.idempotency_key IS '幂等键，用于防止重复发送';
COMMENT ON COLUMN message_records.request_id IS '请求追踪ID';
COMMENT ON COLUMN message_records.sent_at IS '实际发送时间';
```

#### 字段说明

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|---------|--------|------|
| id | BIGSERIAL | - | NO | 自增 | 主键 |
| message_id | VARCHAR | 64 | NO | - | 消息唯一ID |
| message_type | VARCHAR | 20 | NO | 'email' | 消息类型 |
| template_id | BIGINT | - | YES | NULL | 模板ID |
| template_version | INT | - | YES | NULL | 模板版本 |
| recipient | VARCHAR | 255 | NO | - | 接收人 |
| subject | VARCHAR | 255 | YES | NULL | 邮件主题 |
| content | TEXT | - | YES | NULL | 消息内容 |
| template_vars | JSONB | - | YES | NULL | 模板变量 |
| status | VARCHAR | 20 | NO | 'pending' | 发送状态 |
| retry_count | INT | - | NO | 0 | 重试次数 |
| error_message | TEXT | - | YES | NULL | 错误信息 |
| retry_logs | JSONB | - | YES | NULL | 重试日志 |
| sender_info | JSONB | - | YES | NULL | 发送者信息 |
| idempotency_key | VARCHAR | 128 | YES | NULL | 幂等键 |
| request_id | VARCHAR | 64 | YES | NULL | 请求ID |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 更新时间 |
| sent_at | TIMESTAMP | - | YES | NULL | 发送时间 |

#### 索引说明

| 索引名 | 类型 | 字段 | 说明 |
|--------|------|------|------|
| pk_message_records | PRIMARY KEY | id | 主键索引 |
| uk_message_id | UNIQUE | message_id | 唯一索引，保证消息ID唯一 |
| idx_recipient | INDEX | recipient | 按接收人查询 |
| idx_status | INDEX | status | 按状态查询 |
| idx_created_at | INDEX | created_at | 按时间范围查询 |
| idx_idempotency_key | INDEX | idempotency_key | 幂等键查询 |
| fk_template | FOREIGN KEY | template_id | 外键，关联模板表 |

#### 数据示例

```sql
INSERT INTO message_records (
    message_id, message_type, recipient, subject, content, status
) VALUES (
    'msg_20251024_abc123',
    'email',
    'user@example.com',
    '【验证码】您的验证码',
    '<p>您的验证码是：<strong>123456</strong></p>',
    'success'
);
```

---

### 3.2 消息模板表 (message_templates)

**表说明**：存储消息模板，支持多渠道（邮件、短信、微信等）。

**预估行数**：< 100

#### 表结构

```sql
CREATE TABLE message_templates (
    -- 主键
    id BIGSERIAL PRIMARY KEY,
    
    -- 业务字段
    template_name VARCHAR(100) UNIQUE NOT NULL,
    template_type VARCHAR(20) NOT NULL DEFAULT 'email',
    subject VARCHAR(255),
    content TEXT NOT NULL,
    variables JSONB,
    version INT DEFAULT 1,
    is_active BOOLEAN DEFAULT TRUE,
    description TEXT,
    created_by VARCHAR(100),
    updated_by VARCHAR(100),
    
    -- 审计字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_template_name ON message_templates(template_name);
CREATE INDEX idx_template_type ON message_templates(template_type);
CREATE INDEX idx_is_active ON message_templates(is_active);
CREATE INDEX idx_deleted_at ON message_templates(deleted_at);

-- 添加字段注释
COMMENT ON TABLE message_templates IS '消息模板表';
COMMENT ON COLUMN message_templates.template_name IS '模板名称，唯一';
COMMENT ON COLUMN message_templates.template_type IS '模板类型: email/sms/wechat';
COMMENT ON COLUMN message_templates.subject IS '邮件主题模板';
COMMENT ON COLUMN message_templates.content IS '内容模板，使用Jinja2语法';
COMMENT ON COLUMN message_templates.variables IS '变量列表，JSON数组格式';
COMMENT ON COLUMN message_templates.version IS '当前版本号';
COMMENT ON COLUMN message_templates.is_active IS '是否启用';
COMMENT ON COLUMN message_templates.description IS '模板描述';
COMMENT ON COLUMN message_templates.created_by IS '创建人';
COMMENT ON COLUMN message_templates.updated_by IS '最后修改人';
COMMENT ON COLUMN message_templates.deleted_at IS '软删除时间';
```

#### 字段说明

| 字段名 | 类型 | 长度 | 允许NULL | 默认值 | 说明 |
|--------|------|------|---------|--------|------|
| id | BIGSERIAL | - | NO | 自增 | 主键 |
| template_name | VARCHAR | 100 | NO | - | 模板名称 |
| template_type | VARCHAR | 20 | NO | 'email' | 模板类型 |
| subject | VARCHAR | 255 | YES | NULL | 主题模板 |
| content | TEXT | - | NO | - | 内容模板 |
| variables | JSONB | - | YES | NULL | 变量列表 |
| version | INT | - | NO | 1 | 版本号 |
| is_active | BOOLEAN | - | NO | TRUE | 是否启用 |
| description | TEXT | - | YES | NULL | 描述 |
| created_by | VARCHAR | 100 | YES | NULL | 创建人 |
| updated_by | VARCHAR | 100 | YES | NULL | 修改人 |
| created_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | - | NO | CURRENT_TIMESTAMP | 更新时间 |
| deleted_at | TIMESTAMP | - | YES | NULL | 删除时间 |

---

### 3.3 模板历史表 (message_template_history)

**表说明**：存储模板的历史版本，用于版本管理和回滚。

**预估行数**：< 500

#### 表结构

```sql
CREATE TABLE message_template_history (
    -- 主键
    id BIGSERIAL PRIMARY KEY,
    
    -- 业务字段
    template_id BIGINT NOT NULL,
    version INT NOT NULL,
    template_name VARCHAR(100) NOT NULL,
    template_type VARCHAR(20) NOT NULL,
    subject VARCHAR(255),
    content TEXT NOT NULL,
    variables JSONB,
    change_description TEXT,
    created_by VARCHAR(100),
    
    -- 审计字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    -- 唯一约束
    CONSTRAINT uk_template_version UNIQUE (template_id, version),
    
    -- 外键约束
    CONSTRAINT fk_template_history 
        FOREIGN KEY (template_id) 
        REFERENCES message_templates(id) 
        ON DELETE CASCADE
);

-- 创建索引
CREATE INDEX idx_template_id ON message_template_history(template_id);
CREATE INDEX idx_version ON message_template_history(template_id, version);

-- 添加字段注释
COMMENT ON TABLE message_template_history IS '模板历史版本表';
COMMENT ON COLUMN message_template_history.template_id IS '关联的模板ID';
COMMENT ON COLUMN message_template_history.version IS '版本号';
COMMENT ON COLUMN message_template_history.change_description IS '本次修改说明';
```

---

### 3.4 邮箱账户表 (email_accounts)

**表说明**：存储邮箱池中的SMTP账户信息。

**预估行数**：< 50

#### 表结构

```sql
CREATE TABLE email_accounts (
    -- 主键
    id BIGSERIAL PRIMARY KEY,
    
    -- 业务字段
    email VARCHAR(255) UNIQUE NOT NULL,
    smtp_host VARCHAR(255) NOT NULL,
    smtp_port INT NOT NULL,
    smtp_username VARCHAR(255) NOT NULL,
    smtp_password VARCHAR(255) NOT NULL,
    display_name VARCHAR(100),
    daily_limit INT DEFAULT 500,
    daily_sent_count INT DEFAULT 0,
    last_reset_date DATE DEFAULT CURRENT_DATE,
    is_active BOOLEAN DEFAULT TRUE,
    priority INT DEFAULT 0,
    failure_count INT DEFAULT 0,
    last_failure_at TIMESTAMP,
    
    -- 审计字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_email ON email_accounts(email);
CREATE INDEX idx_is_active ON email_accounts(is_active);
CREATE INDEX idx_priority ON email_accounts(priority DESC, daily_sent_count ASC);

-- 添加字段注释
COMMENT ON TABLE email_accounts IS '邮箱账户池';
COMMENT ON COLUMN email_accounts.email IS '邮箱地址';
COMMENT ON COLUMN email_accounts.smtp_host IS 'SMTP服务器地址';
COMMENT ON COLUMN email_accounts.smtp_port IS 'SMTP端口';
COMMENT ON COLUMN email_accounts.smtp_username IS 'SMTP用户名';
COMMENT ON COLUMN email_accounts.smtp_password IS 'SMTP密码（AES-256-GCM加密存储）';
COMMENT ON COLUMN email_accounts.display_name IS '发件人显示名称';
COMMENT ON COLUMN email_accounts.daily_limit IS '日发送上限';
COMMENT ON COLUMN email_accounts.daily_sent_count IS '当日已发送数量';
COMMENT ON COLUMN email_accounts.last_reset_date IS '上次重置日期';
COMMENT ON COLUMN email_accounts.is_active IS '是否启用';
COMMENT ON COLUMN email_accounts.priority IS '优先级，数字越大越优先';
COMMENT ON COLUMN email_accounts.failure_count IS '连续失败次数';
COMMENT ON COLUMN email_accounts.last_failure_at IS '最后失败时间';

-- 创建触发器：自动重置日发送计数
CREATE OR REPLACE FUNCTION reset_daily_count_if_needed()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.last_reset_date < CURRENT_DATE THEN
        NEW.daily_sent_count = 0;
        NEW.last_reset_date = CURRENT_DATE;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_reset_daily_count
BEFORE UPDATE ON email_accounts
FOR EACH ROW
EXECUTE FUNCTION reset_daily_count_if_needed();
```

---

### 3.5 邮件附件表 (email_attachments)

**表说明**：存储邮件附件的元信息。

**预估行数**：50万/年

#### 表结构

```sql
CREATE TABLE email_attachments (
    -- 主键
    id BIGSERIAL PRIMARY KEY,
    
    -- 业务字段
    attachment_id VARCHAR(64) UNIQUE NOT NULL,
    filename VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size BIGINT NOT NULL,
    mime_type VARCHAR(100),
    uploaded_by VARCHAR(100),
    expires_at TIMESTAMP,
    
    -- 审计字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_attachment_id ON email_attachments(attachment_id);
CREATE INDEX idx_expires_at ON email_attachments(expires_at);

-- 添加字段注释
COMMENT ON TABLE email_attachments IS '邮件附件表';
COMMENT ON COLUMN email_attachments.attachment_id IS '附件唯一ID';
COMMENT ON COLUMN email_attachments.filename IS '原始文件名';
COMMENT ON COLUMN email_attachments.file_path IS '存储路径';
COMMENT ON COLUMN email_attachments.file_size IS '文件大小（字节）';
COMMENT ON COLUMN email_attachments.mime_type IS 'MIME类型';
COMMENT ON COLUMN email_attachments.uploaded_by IS '上传者';
COMMENT ON COLUMN email_attachments.expires_at IS '过期时间（7天后自动清理）';
```

---

### 3.6 API密钥表 (api_keys)

**表说明**：存储API认证密钥。

**预估行数**：< 100

#### 表结构

```sql
CREATE TABLE api_keys (
    -- 主键
    id BIGSERIAL PRIMARY KEY,
    
    -- 业务字段
    key_name VARCHAR(100) NOT NULL,
    api_key VARCHAR(64) UNIQUE NOT NULL,
    api_secret_hash VARCHAR(255) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    expire_at TIMESTAMP,
    last_used_at TIMESTAMP,
    usage_count BIGINT DEFAULT 0,
    description TEXT,
    created_by VARCHAR(100),
    
    -- 审计字段
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_api_key ON api_keys(api_key);
CREATE INDEX idx_is_active ON api_keys(is_active);

-- 添加字段注释
COMMENT ON TABLE api_keys IS 'API密钥表';
COMMENT ON COLUMN api_keys.key_name IS '密钥名称';
COMMENT ON COLUMN api_keys.api_key IS 'API Key，格式: noti_{random}';
COMMENT ON COLUMN api_keys.api_secret_hash IS 'API Secret的bcrypt哈希值';
COMMENT ON COLUMN api_keys.is_active IS '是否启用';
COMMENT ON COLUMN api_keys.expire_at IS '过期时间';
COMMENT ON COLUMN api_keys.last_used_at IS '最后使用时间';
COMMENT ON COLUMN api_keys.usage_count IS '使用次数统计';
COMMENT ON COLUMN api_keys.description IS '描述信息';
COMMENT ON COLUMN api_keys.created_by IS '创建人';
```

---

## 四、索引设计

### 4.1 索引设计原则

#### 【强制】业务上具有唯一特性的字段，必须建成唯一索引

**说明**：即使是多个字段的组合，也必须建成唯一索引。

**正例**：
- `message_id`：消息唯一标识
- `email`：邮箱地址
- `api_key`：API密钥
- `(template_id, version)`：模板ID和版本号组合

#### 【强制】超过三个表禁止join，需要join的字段，数据类型必须绝对一致

**说明**：多表关联查询时，保证被关联的字段需要有索引。

#### 【强制】在varchar字段上建立索引时，必须指定索引长度

**说明**：索引的长度与区分度是一对矛盾体，一般对字符串类型数据，长度为20的索引，区分度会高达90%以上。

**正例**：
```sql
CREATE INDEX idx_recipient_prefix ON message_records(recipient(20));
```

#### 【强制】页面搜索严禁左模糊或者全模糊，如果需要请走搜索引擎来解决

**说明**：索引文件具有B+树的最左前缀匹配特性，如果左边的值未确定，那么无法使用此索引。

#### 【推荐】SQL性能优化的目标：至少要达到range级别，要求是ref级别，如果可以是const最好

**说明**：
- const：单表中最多只有一个匹配行（主键或唯一索引）
- ref：通过索引列，可以直接引用到某些数据行
- range：索引范围扫描
- index：索引全扫描
- ALL：全表扫描

### 4.2 索引清单

#### message_records表索引

| 索引名 | 类型 | 字段 | 基数（区分度） | 说明 |
|--------|------|------|---------------|------|
| PRIMARY | 主键 | id | 100% | 主键索引 |
| uk_message_id | 唯一 | message_id | 100% | 消息ID唯一索引 |
| idx_recipient | 普通 | recipient | 80% | 按接收人查询 |
| idx_status | 普通 | status | 20% | 按状态查询（4种状态）|
| idx_created_at | 普通 | created_at | 95% | 按时间查询 |
| idx_idempotency_key | 普通 | idempotency_key | 95% | 幂等键查询 |

#### email_accounts表索引

| 索引名 | 类型 | 字段 | 基数（区分度） | 说明 |
|--------|------|------|---------------|------|
| PRIMARY | 主键 | id | 100% | 主键索引 |
| uk_email | 唯一 | email | 100% | 邮箱地址唯一索引 |
| idx_is_active | 普通 | is_active | 50% | 按状态查询 |
| idx_priority | 复合 | priority, daily_sent_count | 90% | 邮箱选择排序 |

---

## 五、ER图说明

### 5.1 实体关系概述

```
message_templates (1) ----< (N) message_records
                           关系：一个模板可以被多条消息使用

message_templates (1) ----< (N) message_template_history
                           关系：一个模板有多个历史版本

api_keys (认证信息) --> message_records (使用记录)
                     关系：通过request_id关联
```

### 5.2 ER图（文本描述）

```
┌─────────────────────────┐
│  message_templates      │
│─────────────────────────│
│  PK  id                 │
│  UK  template_name      │
│      template_type      │
│      subject            │
│      content            │
│      variables          │
│      version            │
│      ...                │
└───────┬─────────────────┘
        │
        │ 1:N
        │
        ▼
┌─────────────────────────┐         ┌──────────────────────┐
│  message_records        │         │  email_attachments   │
│─────────────────────────│         │──────────────────────│
│  PK  id                 │◄────────│  PK  id              │
│  UK  message_id         │  通过   │  UK  attachment_id   │
│  FK  template_id        │ JSON数组 │      filename        │
│      recipient          │  关联   │      file_path       │
│      subject            │         │      file_size       │
│      content            │         │      ...             │
│      status             │         └──────────────────────┘
│      ...                │
└─────────────────────────┘

┌─────────────────────────┐
│  email_accounts         │
│─────────────────────────│
│  PK  id                 │
│  UK  email              │
│      smtp_host          │
│      smtp_port          │
│      daily_limit        │
│      daily_sent_count   │
│      priority           │
│      ...                │
└─────────────────────────┘

┌─────────────────────────┐
│  api_keys               │
│─────────────────────────│
│  PK  id                 │
│  UK  api_key            │
│      api_secret_hash    │
│      is_active          │
│      usage_count        │
│      ...                │
└─────────────────────────┘
```

### 5.3 关系说明

1. **message_templates ← message_records**
   - 关系类型：一对多（1:N）
   - 外键：`message_records.template_id` -> `message_templates.id`
   - 级联操作：ON DELETE SET NULL（删除模板时，消息记录的template_id设为NULL）

2. **message_templates ← message_template_history**
   - 关系类型：一对多（1:N）
   - 外键：`message_template_history.template_id` -> `message_templates.id`
   - 级联操作：ON DELETE CASCADE（删除模板时，同时删除历史记录）

3. **message_records ← email_attachments**
   - 关系类型：多对多（通过JSON数组关联）
   - 实现方式：`message_records`表的某个字段存储`attachment_ids`数组
   - 说明：一条消息可以有多个附件，一个附件可以被多条消息使用

---

## 六、初始化脚本

### 6.1 数据库初始化脚本

```sql
-- ============================================
-- 消息通知平台数据库初始化脚本
-- 版本：v1.0
-- 日期：2025-10-24
-- ============================================

-- 1. 创建数据库
CREATE DATABASE notification_db
    WITH 
    OWNER = notification_user
    ENCODING = 'UTF8'
    LC_COLLATE = 'zh_CN.UTF-8'
    LC_CTYPE = 'zh_CN.UTF-8'
    TABLESPACE = pg_default
    CONNECTION LIMIT = -1;

-- 2. 切换到数据库
\c notification_db;

-- 3. 创建表（按依赖顺序）

-- 3.1 创建消息模板表
CREATE TABLE message_templates (
    id BIGSERIAL PRIMARY KEY,
    template_name VARCHAR(100) UNIQUE NOT NULL,
    template_type VARCHAR(20) NOT NULL DEFAULT 'email',
    subject VARCHAR(255),
    content TEXT NOT NULL,
    variables JSONB,
    version INT DEFAULT 1,
    is_active BOOLEAN DEFAULT TRUE,
    description TEXT,
    created_by VARCHAR(100),
    updated_by VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);

CREATE INDEX idx_template_name ON message_templates(template_name);
CREATE INDEX idx_template_type ON message_templates(template_type);
CREATE INDEX idx_is_active ON message_templates(is_active);

COMMENT ON TABLE message_templates IS '消息模板表';

-- 3.2 创建模板历史表
CREATE TABLE message_template_history (
    id BIGSERIAL PRIMARY KEY,
    template_id BIGINT NOT NULL,
    version INT NOT NULL,
    template_name VARCHAR(100) NOT NULL,
    template_type VARCHAR(20) NOT NULL,
    subject VARCHAR(255),
    content TEXT NOT NULL,
    variables JSONB,
    change_description TEXT,
    created_by VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    CONSTRAINT uk_template_version UNIQUE (template_id, version),
    CONSTRAINT fk_template_history 
        FOREIGN KEY (template_id) 
        REFERENCES message_templates(id) 
        ON DELETE CASCADE
);

CREATE INDEX idx_template_id ON message_template_history(template_id);

COMMENT ON TABLE message_template_history IS '模板历史版本表';

-- 3.3 创建消息记录表
CREATE TABLE message_records (
    id BIGSERIAL PRIMARY KEY,
    message_id VARCHAR(64) UNIQUE NOT NULL,
    message_type VARCHAR(20) NOT NULL DEFAULT 'email',
    template_id BIGINT,
    template_version INT,
    recipient VARCHAR(255) NOT NULL,
    subject VARCHAR(255),
    content TEXT,
    template_vars JSONB,
    status VARCHAR(20) NOT NULL DEFAULT 'pending',
    retry_count INT DEFAULT 0,
    error_message TEXT,
    retry_logs JSONB,
    sender_info JSONB,
    idempotency_key VARCHAR(128),
    request_id VARCHAR(64),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    sent_at TIMESTAMP,
    
    CONSTRAINT fk_template 
        FOREIGN KEY (template_id) 
        REFERENCES message_templates(id) 
        ON DELETE SET NULL
);

CREATE INDEX idx_message_id ON message_records(message_id);
CREATE INDEX idx_recipient ON message_records(recipient);
CREATE INDEX idx_status ON message_records(status);
CREATE INDEX idx_created_at ON message_records(created_at);
CREATE INDEX idx_idempotency_key ON message_records(idempotency_key);

COMMENT ON TABLE message_records IS '消息发送记录表';

-- 3.4 创建邮箱账户表
CREATE TABLE email_accounts (
    id BIGSERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    smtp_host VARCHAR(255) NOT NULL,
    smtp_port INT NOT NULL,
    smtp_username VARCHAR(255) NOT NULL,
    smtp_password VARCHAR(255) NOT NULL,
    display_name VARCHAR(100),
    daily_limit INT DEFAULT 500,
    daily_sent_count INT DEFAULT 0,
    last_reset_date DATE DEFAULT CURRENT_DATE,
    is_active BOOLEAN DEFAULT TRUE,
    priority INT DEFAULT 0,
    failure_count INT DEFAULT 0,
    last_failure_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_email ON email_accounts(email);
CREATE INDEX idx_is_active ON email_accounts(is_active);
CREATE INDEX idx_priority ON email_accounts(priority DESC, daily_sent_count ASC);

COMMENT ON TABLE email_accounts IS '邮箱账户池';

-- 创建触发器：自动重置日发送计数
CREATE OR REPLACE FUNCTION reset_daily_count_if_needed()
RETURNS TRIGGER AS $$
BEGIN
    IF NEW.last_reset_date < CURRENT_DATE THEN
        NEW.daily_sent_count = 0;
        NEW.last_reset_date = CURRENT_DATE;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_reset_daily_count
BEFORE UPDATE ON email_accounts
FOR EACH ROW
EXECUTE FUNCTION reset_daily_count_if_needed();

-- 3.5 创建邮件附件表
CREATE TABLE email_attachments (
    id BIGSERIAL PRIMARY KEY,
    attachment_id VARCHAR(64) UNIQUE NOT NULL,
    filename VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size BIGINT NOT NULL,
    mime_type VARCHAR(100),
    uploaded_by VARCHAR(100),
    expires_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_attachment_id ON email_attachments(attachment_id);
CREATE INDEX idx_expires_at ON email_attachments(expires_at);

COMMENT ON TABLE email_attachments IS '邮件附件表';

-- 3.6 创建API密钥表
CREATE TABLE api_keys (
    id BIGSERIAL PRIMARY KEY,
    key_name VARCHAR(100) NOT NULL,
    api_key VARCHAR(64) UNIQUE NOT NULL,
    api_secret_hash VARCHAR(255) NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    expire_at TIMESTAMP,
    last_used_at TIMESTAMP,
    usage_count BIGINT DEFAULT 0,
    description TEXT,
    created_by VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_api_key ON api_keys(api_key);
CREATE INDEX idx_is_active ON api_keys(is_active);

COMMENT ON TABLE api_keys IS 'API密钥表';

-- 4. 插入初始数据

-- 4.1 插入示例API密钥（用于测试）
-- 注意：生产环境需要使用真实的bcrypt哈希
INSERT INTO api_keys (key_name, api_key, api_secret_hash, description, created_by)
VALUES (
    '测试密钥',
    'noti_test_key_123456',
    '$2b$12$KIXxGWCZQp5vpLvGAlY4qO8w9pzJ7uPJvzxLGKQx7PnN5KwV6Y4Ry',  -- 哈希值: test_secret
    '测试环境使用的API密钥',
    'system'
);

-- 4.2 插入示例邮件模板
INSERT INTO message_templates (
    template_name, template_type, subject, content, variables, description, created_by
) VALUES (
    '注册验证码',
    'email',
    '【验证码】{{username}}，您的验证码',
    '<div style="font-family: Arial, sans-serif; padding: 20px;">
        <h2>尊敬的{{username}}，您好！</h2>
        <p>您的验证码是：<strong style="color: #ff6600; font-size: 24px;">{{code}}</strong></p>
        <p>验证码有效期为{{expire_minutes}}分钟，请及时使用。</p>
        <p style="color: #999; font-size: 12px;">如果这不是您的操作，请忽略此邮件。</p>
    </div>',
    '["username", "code", "expire_minutes"]'::jsonb,
    '用户注册时发送的验证码邮件模板',
    'system'
);

-- 完成
SELECT 'Database initialization completed successfully!' AS status;
```

### 6.2 清理脚本

```sql
-- ============================================
-- 数据库清理脚本（谨慎使用！）
-- ============================================

-- 1. 删除所有表（按依赖顺序反向删除）
DROP TABLE IF EXISTS api_keys CASCADE;
DROP TABLE IF EXISTS email_attachments CASCADE;
DROP TABLE IF EXISTS email_accounts CASCADE;
DROP TABLE IF EXISTS message_records CASCADE;
DROP TABLE IF EXISTS message_template_history CASCADE;
DROP TABLE IF EXISTS message_templates CASCADE;

-- 2. 删除触发器函数
DROP FUNCTION IF EXISTS reset_daily_count_if_needed() CASCADE;

-- 3. 删除数据库（可选）
-- DROP DATABASE IF EXISTS notification_db;

SELECT 'Database cleanup completed!' AS status;
```

---

## 七、数据字典

### 7.1 枚举值定义

#### MessageStatus（消息状态）

| 值 | 说明 | 描述 |
|----|------|------|
| pending | 待发送 | 消息已创建，等待发送 |
| sending | 发送中 | 消息正在发送 |
| success | 发送成功 | 消息发送成功 |
| failed | 发送失败 | 消息发送失败（已达最大重试次数）|

#### MessageType（消息类型）

| 值 | 说明 | 第一期支持 |
|----|------|-----------|
| email | 邮件 | ✅ |
| sms | 短信 | ❌（第二期）|
| wechat | 微信消息 | ❌（第二期）|
| wechat_mp | 微信公众号 | ❌（第二期）|

#### TemplateType（模板类型）

| 值 | 说明 | 第一期支持 |
|----|------|-----------|
| email | 邮件模板 | ✅ |
| sms | 短信模板 | ❌（第二期）|
| wechat | 微信模板 | ❌（第二期）|

### 7.2 JSONB字段结构

#### template_vars（模板变量）

```json
{
    "username": "张三",
    "code": "123456",
    "expire_minutes": "5"
}
```

#### retry_logs（重试日志）

```json
[
    {
        "attempt": 1,
        "timestamp": "2025-10-24T10:00:00Z",
        "error": "SMTP连接超时",
        "next_retry_at": "2025-10-24T10:01:00Z"
    },
    {
        "attempt": 2,
        "timestamp": "2025-10-24T10:01:00Z",
        "error": "SMTP认证失败",
        "next_retry_at": "2025-10-24T10:06:00Z"
    }
]
```

#### sender_info（发送者信息）

```json
{
    "email_account_id": 1,
    "email_address": "noreply@example.com",
    "smtp_host": "smtp.example.com"
}
```

---

## 八、维护建议

### 8.1 数据归档策略

#### 【推荐】定期归档历史数据

- `message_records`：30天后归档到历史表
- `email_attachments`：7天后物理删除文件
- 归档表命名：`message_records_archive_YYYYMM`

#### 归档脚本示例

```sql
-- 创建归档表（每月执行一次）
CREATE TABLE message_records_archive_202510 (
    LIKE message_records INCLUDING ALL
);

-- 归档数据
INSERT INTO message_records_archive_202510
SELECT * FROM message_records
WHERE created_at < '2025-10-01' AND created_at >= '2025-09-01';

-- 删除已归档数据
DELETE FROM message_records
WHERE created_at < '2025-10-01' AND created_at >= '2025-09-01';
```

### 8.2 性能优化建议

#### 【推荐】定期分析表统计信息

```sql
-- 分析所有表
ANALYZE;

-- 分析特定表
ANALYZE message_records;
```

#### 【推荐】定期清理无用索引

```sql
-- 查询未使用的索引
SELECT
    schemaname,
    tablename,
    indexname,
    idx_scan
FROM pg_stat_user_indexes
WHERE idx_scan = 0
AND indexname NOT LIKE '%_pkey';
```

#### 【推荐】监控慢查询

```sql
-- 开启慢查询日志
ALTER SYSTEM SET log_min_duration_statement = 1000;  -- 记录超过1秒的查询

-- 重载配置
SELECT pg_reload_conf();
```

---

## 文档结束

本数据库设计文档参考阿里巴巴数据库设计规范制定，是消息通知平台的数据库设计标准。

**版本更新记录**：
- v1.0 (2025-10-24)：初始版本发布，包含第一期6张表的完整设计

**附录**：
- 数据库初始化脚本：见第六章
- ER图详细版：使用工具生成（推荐使用DBeaver、Navicat等）
- 性能测试报告：待补充

