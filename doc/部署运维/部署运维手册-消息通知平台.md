# éƒ¨ç½²è¿ç»´æ‰‹å†Œ - æ¶ˆæ¯é€šçŸ¥å¹³å°

**ç‰ˆæœ¬**ï¼šv1.0  
**æ—¥æœŸ**ï¼š2025-10-24  
**é€‚ç”¨ç¯å¢ƒ**ï¼šå¼€å‘/æµ‹è¯•/ç”Ÿäº§  
**å‚è€ƒæ ‡å‡†**ï¼šé˜¿é‡Œäº‘è¿ç»´æœ€ä½³å®è·µ

---

## ğŸ“‹ ç›®å½•

1. [ç¯å¢ƒè¦æ±‚](#ä¸€ç¯å¢ƒè¦æ±‚)
2. [å¿«é€Ÿå¼€å§‹](#äºŒå¿«é€Ÿå¼€å§‹)
3. [è¯¦ç»†éƒ¨ç½²æ­¥éª¤](#ä¸‰è¯¦ç»†éƒ¨ç½²æ­¥éª¤)
4. [é…ç½®è¯´æ˜](#å››é…ç½®è¯´æ˜)
5. [è¿ç»´æ“ä½œ](#äº”è¿ç»´æ“ä½œ)
6. [ç›‘æ§å‘Šè­¦](#å…­ç›‘æ§å‘Šè­¦)
7. [æ•…éšœæ’æŸ¥](#ä¸ƒæ•…éšœæ’æŸ¥)
8. [å¸¸è§é—®é¢˜](#å…«å¸¸è§é—®é¢˜)

---

## ä¸€ã€ç¯å¢ƒè¦æ±‚

### 1.1 ç¡¬ä»¶è¦æ±‚

#### å¼€å‘ç¯å¢ƒï¼ˆæœ€ä½é…ç½®ï¼‰

| ç»„ä»¶ | é…ç½®è¦æ±‚ |
|------|---------|
| CPU | 2æ ¸ |
| å†…å­˜ | 4GB |
| ç¡¬ç›˜ | 20GB |
| ç½‘ç»œ | 1Mbps |

#### ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èé…ç½®ï¼‰

| ç»„ä»¶ | é…ç½®è¦æ±‚ | è¯´æ˜ |
|------|---------|------|
| CPU | 4æ ¸+ | æ”¯æŒå¤šå¹¶å‘å¤„ç† |
| å†…å­˜ | 8GB+ | æ•°æ®åº“å’Œç¼“å­˜éœ€è¦è¾ƒå¤§å†…å­˜ |
| ç¡¬ç›˜ | 100GB+ SSD | æ•°æ®åº“å»ºè®®ä½¿ç”¨SSD |
| ç½‘ç»œ | 10Mbps+ | ä¿è¯SMTPè¿æ¥ç¨³å®š |

### 1.2 è½¯ä»¶è¦æ±‚

| è½¯ä»¶ | ç‰ˆæœ¬è¦æ±‚ | è¯´æ˜ |
|------|---------|------|
| Docker | 20.10+ | å®¹å™¨è¿è¡Œç¯å¢ƒ |
| Docker Compose | 2.0+ | å¤šå®¹å™¨ç¼–æ’ |
| Python | 3.10+ | åº”ç”¨è¿è¡Œç¯å¢ƒï¼ˆå®¹å™¨å†…è‡ªåŠ¨å®‰è£…ï¼‰|
| PostgreSQL | 14+ | æ•°æ®åº“ï¼ˆDockeré•œåƒï¼‰|
| Redis | 7+ | ç¼“å­˜å’Œæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆDockeré•œåƒï¼‰|
| RabbitMQ | 3.11+ | æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆDockeré•œåƒï¼‰|

### 1.3 æ“ä½œç³»ç»Ÿè¦æ±‚

**æ”¯æŒçš„æ“ä½œç³»ç»Ÿ**ï¼š
- âœ… Linux (Ubuntu 20.04+, CentOS 7+, Debian 10+)
- âœ… macOS 11+
- âœ… Windows 10+ (WSL2)

**æ¨è**ï¼šUbuntu 22.04 LTS

---

## äºŒã€å¿«é€Ÿå¼€å§‹

### 2.1 ä¸€é”®éƒ¨ç½²ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

```bash
# 1. å…‹éš†ä»£ç ä»“åº“
git clone https://github.com/your-org/notification-platform.git
cd notification-platform

# 2. å¤åˆ¶ç¯å¢ƒå˜é‡é…ç½®
cp .env.example .env

# 3. ä¿®æ”¹ç¯å¢ƒå˜é‡ï¼ˆä¿®æ”¹å¯†ç ç­‰æ•æ„Ÿä¿¡æ¯ï¼‰
vim .env

# 4. å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# 5. æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# 6. æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# 7. åˆå§‹åŒ–æ•°æ®åº“
docker-compose exec api python -m alembic upgrade head

# 8. åˆ›å»ºåˆå§‹APIå¯†é’¥
docker-compose exec api python scripts/create_api_key.py

# 9. è®¿é—®APIæ–‡æ¡£
# æµè§ˆå™¨æ‰“å¼€: http://localhost:8000/docs
```

### 2.2 éªŒè¯éƒ¨ç½²

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8000/health

# å°±ç»ªæ£€æŸ¥
curl http://localhost:8000/health/ready

# æŸ¥çœ‹ç›‘æ§æŒ‡æ ‡
curl http://localhost:8000/metrics

# æŸ¥çœ‹RabbitMQç®¡ç†ç•Œé¢
# æµè§ˆå™¨æ‰“å¼€: http://localhost:15672
# ç”¨æˆ·å: admin
# å¯†ç : åœ¨.envä¸­é…ç½®çš„RABBITMQ_PASSWORD
```

**é¢„æœŸè¾“å‡º**ï¼š
```json
{
  "status": "healthy"
}
```

---

## ä¸‰ã€è¯¦ç»†éƒ¨ç½²æ­¥éª¤

### 3.1 å‡†å¤‡å·¥ä½œ

#### 3.1.1 å®‰è£…Dockerå’ŒDocker Compose

**Ubuntu/Debian**ï¼š
```bash
# æ›´æ–°åŒ…ç´¢å¼•
sudo apt-get update

# å®‰è£…ä¾èµ–
sudo apt-get install -y \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

# æ·»åŠ Dockerå®˜æ–¹GPGå¯†é’¥
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# è®¾ç½®Dockerä»“åº“
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# å®‰è£…Docker
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# éªŒè¯å®‰è£…
docker --version
docker compose version

# å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ°dockerç»„ï¼ˆé¿å…æ¯æ¬¡ä½¿ç”¨sudoï¼‰
sudo usermod -aG docker $USER
newgrp docker
```

**CentOS/RHEL**ï¼š
```bash
# å®‰è£…Docker
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
sudo yum install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

# å¯åŠ¨Docker
sudo systemctl start docker
sudo systemctl enable docker

# éªŒè¯å®‰è£…
docker --version
```

#### 3.1.2 é…ç½®ç³»ç»Ÿå‚æ•°

**ä¼˜åŒ–Linuxå†…æ ¸å‚æ•°**ï¼š
```bash
# ç¼–è¾‘ç³»ç»Ÿé…ç½®
sudo vim /etc/sysctl.conf

# æ·»åŠ ä»¥ä¸‹é…ç½®
vm.max_map_count=262144
net.core.somaxconn=65535
net.ipv4.tcp_max_syn_backlog=8192
fs.file-max=655360

# åº”ç”¨é…ç½®
sudo sysctl -p
```

**é…ç½®æ–‡ä»¶æè¿°ç¬¦é™åˆ¶**ï¼š
```bash
# ç¼–è¾‘limitsé…ç½®
sudo vim /etc/security/limits.conf

# æ·»åŠ ä»¥ä¸‹é…ç½®
* soft nofile 65535
* hard nofile 65535
* soft nproc 65535
* hard nproc 65535

# é‡æ–°ç™»å½•ä½¿é…ç½®ç”Ÿæ•ˆ
```

### 3.2 éƒ¨ç½²åº”ç”¨

#### 3.2.1 è·å–ä»£ç 

```bash
# æ–¹å¼1ï¼šä»Gitä»“åº“å…‹éš†
git clone https://github.com/your-org/notification-platform.git
cd notification-platform

# æ–¹å¼2ï¼šä»å‘å¸ƒåŒ…è§£å‹
tar -xzf notification-platform-v1.0.0.tar.gz
cd notification-platform
```

#### 3.2.2 é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶é…ç½®æ–‡ä»¶
cp .env.example .env

# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim .env
```

**é‡è¦é…ç½®é¡¹**ï¼ˆè¯¦è§ç¬¬å››ç« ï¼‰ï¼š
```env
# æ•°æ®åº“å¯†ç ï¼ˆå¿…é¡»ä¿®æ”¹ï¼‰
DB_PASSWORD=your_secure_password_here

# RabbitMQå¯†ç ï¼ˆå¿…é¡»ä¿®æ”¹ï¼‰
RABBITMQ_PASSWORD=your_rabbitmq_password_here

# JWTå¯†é’¥ï¼ˆå¿…é¡»ä¿®æ”¹ï¼Œè‡³å°‘32ä½ï¼‰
JWT_SECRET_KEY=your_jwt_secret_key_at_least_32_chars

# åŠ å¯†å¯†é’¥ï¼ˆå¿…é¡»ä¿®æ”¹ï¼ŒBase64ç¼–ç ï¼‰
ENCRYPTION_KEY=your_encryption_key_base64_encoded

# ç¯å¢ƒæ ‡è¯†
ENV=production
DEBUG=false
```

#### 3.2.3 ç”ŸæˆåŠ å¯†å¯†é’¥

```bash
# ç”ŸæˆFernetåŠ å¯†å¯†é’¥ï¼ˆPythonï¼‰
python3 << EOF
from cryptography.fernet import Fernet
key = Fernet.generate_key()
print(f"ENCRYPTION_KEY={key.decode()}")
EOF

# ç”ŸæˆéšæœºJWTå¯†é’¥
openssl rand -base64 32

# å°†ç”Ÿæˆçš„å¯†é’¥å¡«å…¥.envæ–‡ä»¶
```

#### 3.2.4 å¯åŠ¨æœåŠ¡

```bash
# æ‹‰å–é•œåƒ
docker-compose pull

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
docker-compose logs -f

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps
```

**é¢„æœŸè¾“å‡º**ï¼š
```
NAME                    STATUS              PORTS
notification-api        Up 30 seconds       0.0.0.0:8000->8000/tcp
notification-worker     Up 30 seconds
notification-beat       Up 30 seconds
notification-db         Up 30 seconds       0.0.0.0:5432->5432/tcp
notification-redis      Up 30 seconds       0.0.0.0:6379->6379/tcp
notification-rabbitmq   Up 30 seconds       0.0.0.0:5672->5672/tcp, 0.0.0.0:15672->15672/tcp
```

#### 3.2.5 åˆå§‹åŒ–æ•°æ®åº“

```bash
# è¿›å…¥APIå®¹å™¨
docker-compose exec api bash

# è¿è¡Œæ•°æ®åº“è¿ç§»
alembic upgrade head

# æŸ¥çœ‹å½“å‰ç‰ˆæœ¬
alembic current

# é€€å‡ºå®¹å™¨
exit
```

#### 3.2.6 åˆ›å»ºåˆå§‹æ•°æ®

```bash
# åˆ›å»ºAPIå¯†é’¥
docker-compose exec api python scripts/create_api_key.py \
  --name "é»˜è®¤å¯†é’¥" \
  --description "ç³»ç»Ÿåˆå§‹åŒ–åˆ›å»ºçš„APIå¯†é’¥"

# è¾“å‡ºç¤ºä¾‹ï¼š
# API Key: noti_abc123def456...
# API Secret: secret_xyz789... (è¯·å¦¥å–„ä¿ç®¡ï¼)
```

#### 3.2.7 å¯¼å…¥é‚®ç®±è´¦æˆ·

```bash
# æ–¹å¼1ï¼šé€šè¿‡APIå¯¼å…¥ï¼ˆæ¨èï¼‰
curl -X POST http://localhost:8000/api/v1/admin/email-accounts \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "noreply@example.com",
    "smtp_host": "smtp.example.com",
    "smtp_port": 465,
    "smtp_username": "noreply@example.com",
    "smtp_password": "your_password",
    "display_name": "ç³»ç»Ÿé€šçŸ¥",
    "daily_limit": 500,
    "priority": 10
  }'

# æ–¹å¼2ï¼šé€šè¿‡SQLå¯¼å…¥
docker-compose exec -T db psql -U notification_user -d notification_db << EOF
INSERT INTO email_accounts (email, smtp_host, smtp_port, smtp_username, smtp_password, display_name, daily_limit, priority)
VALUES 
  ('account1@example.com', 'smtp.example.com', 465, 'account1@example.com', 'encrypted_password', 'Account 1', 500, 10),
  ('account2@example.com', 'smtp.example.com', 465, 'account2@example.com', 'encrypted_password', 'Account 2', 500, 5);
EOF
```

### 3.3 éªŒè¯éƒ¨ç½²

#### 3.3.1 å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥æ‰€æœ‰æœåŠ¡
./scripts/health_check.sh

# æˆ–æ‰‹åŠ¨æ£€æŸ¥
curl http://localhost:8000/health/ready | jq
```

#### 3.3.2 å‘é€æµ‹è¯•é‚®ä»¶

```bash
# 1. è·å–Token
TOKEN=$(curl -s -X POST http://localhost:8000/api/v1/auth/token \
  -H "Content-Type: application/json" \
  -d '{
    "api_key": "YOUR_API_KEY",
    "api_secret": "YOUR_API_SECRET"
  }' | jq -r '.data.access_token')

# 2. å‘é€æµ‹è¯•é‚®ä»¶
curl -X POST http://localhost:8000/api/v1/messages/email/send \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "to": "test@example.com",
    "subject": "æµ‹è¯•é‚®ä»¶",
    "content": "<h1>è¿™æ˜¯ä¸€å°æµ‹è¯•é‚®ä»¶</h1><p>å¦‚æœæ‚¨æ”¶åˆ°æ­¤é‚®ä»¶ï¼Œè¯´æ˜ç³»ç»Ÿéƒ¨ç½²æˆåŠŸï¼</p>"
  }' | jq
```

---

## å››ã€é…ç½®è¯´æ˜

### 4.1 ç¯å¢ƒå˜é‡é…ç½®

#### å®Œæ•´çš„.envé…ç½®æ–‡ä»¶

```env
# ==================== ç¯å¢ƒé…ç½® ====================
ENV=production                      # ç¯å¢ƒ: development/staging/production
DEBUG=false                         # è°ƒè¯•æ¨¡å¼ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¸ºfalseï¼‰
LOG_LEVEL=INFO                      # æ—¥å¿—çº§åˆ«: DEBUG/INFO/WARNING/ERROR/CRITICAL

# ==================== æ•°æ®åº“é…ç½® ====================
DATABASE_URL=postgresql://notification_user:your_password@postgres:5432/notification_db
DB_POOL_SIZE=5                      # è¿æ¥æ± å¤§å°
DB_MAX_OVERFLOW=15                  # æœ€å¤§æº¢å‡ºè¿æ¥æ•°
DB_POOL_TIMEOUT=30                  # è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰
DB_POOL_RECYCLE=3600                # è¿æ¥å›æ”¶æ—¶é—´ï¼ˆç§’ï¼‰
DB_ECHO=false                       # æ˜¯å¦æ‰“å°SQLï¼ˆç”Ÿäº§ç¯å¢ƒfalseï¼‰

# ==================== Redisé…ç½® ====================
REDIS_URL=redis://redis:6379/0
REDIS_MAX_CONNECTIONS=50            # æœ€å¤§è¿æ¥æ•°
REDIS_SOCKET_TIMEOUT=5              # Socketè¶…æ—¶ï¼ˆç§’ï¼‰
REDIS_SOCKET_CONNECT_TIMEOUT=5      # è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰

# ==================== RabbitMQé…ç½® ====================
RABBITMQ_URL=amqp://admin:your_rabbitmq_password@rabbitmq:5672/
RABBITMQ_PREFETCH_COUNT=10          # æ¶ˆè´¹è€…é¢„å–æ•°é‡
RABBITMQ_HEARTBEAT=60               # å¿ƒè·³é—´éš”ï¼ˆç§’ï¼‰

# ==================== åº”ç”¨é…ç½® ====================
APP_NAME=notification-platform
APP_VERSION=1.0.0
SECRET_KEY=your-secret-key-at-least-32-chars-long
ALLOWED_HOSTS=*                     # ç”Ÿäº§ç¯å¢ƒåº”æŒ‡å®šå…·ä½“åŸŸå

# ==================== JWTé…ç½® ====================
JWT_SECRET_KEY=your-jwt-secret-key-at-least-32-chars
JWT_ALGORITHM=HS256
JWT_EXPIRE_MINUTES=60               # Tokenæœ‰æ•ˆæœŸï¼ˆåˆ†é’Ÿï¼‰
JWT_REFRESH_EXPIRE_DAYS=7           # åˆ·æ–°Tokenæœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰

# ==================== åŠ å¯†é…ç½® ====================
ENCRYPTION_KEY=your-encryption-key-base64-encoded

# ==================== SMTPé…ç½® ====================
EMAIL_TIMEOUT=30                    # SMTPè¶…æ—¶ï¼ˆç§’ï¼‰
EMAIL_MAX_SIZE=20971520             # é‚®ä»¶æœ€å¤§å¤§å°ï¼ˆ20MBï¼‰
EMAIL_USE_TLS=true                  # æ˜¯å¦ä½¿ç”¨TLS

# ==================== é™„ä»¶é…ç½® ====================
ATTACHMENT_STORAGE_PATH=/data/attachments
ATTACHMENT_MAX_SIZE=10485760        # å•ä¸ªé™„ä»¶æœ€å¤§10MB
ATTACHMENT_EXPIRE_DAYS=7            # é™„ä»¶ä¿ç•™å¤©æ•°

# ==================== Celeryé…ç½® ====================
CELERY_BROKER_URL=amqp://admin:your_rabbitmq_password@rabbitmq:5672/
CELERY_RESULT_BACKEND=redis://redis:6379/1
CELERY_WORKER_CONCURRENCY=4         # Workerå¹¶å‘æ•°
CELERY_TASK_TIME_LIMIT=300          # ä»»åŠ¡è¶…æ—¶ï¼ˆç§’ï¼‰
CELERY_TASK_SOFT_TIME_LIMIT=270     # ä»»åŠ¡è½¯è¶…æ—¶ï¼ˆç§’ï¼‰

# ==================== ç›‘æ§é…ç½® ====================
PROMETHEUS_ENABLED=true             # æ˜¯å¦å¯ç”¨Prometheus
METRICS_PORT=9090                   # ç›‘æ§æŒ‡æ ‡ç«¯å£

# ==================== é™æµé…ç½® ====================
RATE_LIMIT_ENABLED=true             # æ˜¯å¦å¯ç”¨é™æµ
RATE_LIMIT_PER_MINUTE=100           # æ¯åˆ†é’Ÿè¯·æ±‚é™åˆ¶

# ==================== å…¶ä»– ====================
TZ=Asia/Shanghai                    # æ—¶åŒº
PYTHONUNBUFFERED=1
WORKERS=4                           # Uvicorn workeræ•°é‡
```

### 4.2 Docker Composeé…ç½®

#### ç”Ÿäº§ç¯å¢ƒdocker-compose.ymlï¼ˆä¼˜åŒ–ç‰ˆï¼‰

```yaml
version: '3.8'

services:
  # PostgreSQLæ•°æ®åº“
  postgres:
    image: postgres:14
    container_name: notification-db
    restart: always
    environment:
      POSTGRES_DB: notification_db
      POSTGRES_USER: notification_user
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups
    ports:
      - "5432:5432"
    networks:
      - notification-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U notification_user"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis
  redis:
    image: redis:7-alpine
    container_name: notification-redis
    restart: always
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - notification-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # RabbitMQ
  rabbitmq:
    image: rabbitmq:3.11-management
    container_name: notification-rabbitmq
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD}
      RABBITMQ_VM_MEMORY_HIGH_WATERMARK: 512MB
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - notification-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  # FastAPIåº”ç”¨
  api:
    build:
      context: .
      dockerfile: docker/Dockerfile
      args:
        ENV: production
    container_name: notification-api
    restart: always
    command: >
      sh -c "alembic upgrade head &&
             uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4"
    volumes:
      - ./logs:/app/logs
      - attachment_data:/data/attachments
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - RABBITMQ_URL=${RABBITMQ_URL}
      - ENV=production
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - notification-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Celery Worker
  celery-worker:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: notification-worker
    restart: always
    command: celery -A app.tasks worker --loglevel=info --concurrency=4 --max-tasks-per-child=1000
    volumes:
      - ./logs:/app/logs
      - attachment_data:/data/attachments
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - RABBITMQ_URL=${RABBITMQ_URL}
      - ENV=production
    depends_on:
      - postgres
      - redis
      - rabbitmq
    networks:
      - notification-network

  # Celery Beat
  celery-beat:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: notification-beat
    restart: always
    command: celery -A app.tasks beat --loglevel=info
    volumes:
      - ./logs:/app/logs
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
      - RABBITMQ_URL=${RABBITMQ_URL}
    depends_on:
      - postgres
      - redis
      - rabbitmq
    networks:
      - notification-network

  # Flower (Celeryç›‘æ§)
  flower:
    build:
      context: .
      dockerfile: docker/Dockerfile
    container_name: notification-flower
    restart: always
    command: celery -A app.tasks flower --port=5555
    ports:
      - "5555:5555"
    environment:
      - CELERY_BROKER_URL=${CELERY_BROKER_URL}
      - CELERY_RESULT_BACKEND=${CELERY_RESULT_BACKEND}
    depends_on:
      - rabbitmq
      - redis
    networks:
      - notification-network

  # Nginx (å¯é€‰ï¼Œç”Ÿäº§ç¯å¢ƒæ¨è)
  nginx:
    image: nginx:alpine
    container_name: notification-nginx
    restart: always
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - api
    networks:
      - notification-network

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
  rabbitmq_data:
    driver: local
  attachment_data:
    driver: local

networks:
  notification-network:
    driver: bridge
```

### 4.3 Nginxé…ç½®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

**nginx/nginx.conf**ï¼š
```nginx
user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
    use epoll;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;
    client_max_body_size 20M;

    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;

    # HTTPé‡å®šå‘åˆ°HTTPS
    server {
        listen 80;
        server_name api.example.com;
        return 301 https://$server_name$request_uri;
    }

    # HTTPSé…ç½®
    server {
        listen 443 ssl http2;
        server_name api.example.com;

        # SSLè¯ä¹¦é…ç½®
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # å®‰å…¨å¤´
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;

        # APIä»£ç†
        location / {
            proxy_pass http://api:8000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_redirect off;
            proxy_buffering off;
            proxy_request_buffering off;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }

        # å¥åº·æ£€æŸ¥ï¼ˆä¸è®°å½•æ—¥å¿—ï¼‰
        location /health {
            proxy_pass http://api:8000;
            access_log off;
        }

        # WebSocketæ”¯æŒï¼ˆå¦‚æœéœ€è¦ï¼‰
        location /ws {
            proxy_pass http://api:8000;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
```

---

## äº”ã€è¿ç»´æ“ä½œ

### 5.1 æ—¥å¸¸æ“ä½œ

#### 5.1.1 æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹èµ„æºä½¿ç”¨æƒ…å†µ
docker stats

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose logs -f api
docker-compose logs -f celery-worker

# æŸ¥çœ‹æœ€è¿‘100è¡Œæ—¥å¿—
docker-compose logs --tail=100 api
```

#### 5.1.2 é‡å¯æœåŠ¡

```bash
# é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose restart

# é‡å¯ç‰¹å®šæœåŠ¡
docker-compose restart api
docker-compose restart celery-worker

# ä¼˜é›…é‡å¯ï¼ˆç­‰å¾…å½“å‰ä»»åŠ¡å®Œæˆï¼‰
docker-compose stop api
docker-compose up -d api
```

#### 5.1.3 æ›´æ–°åº”ç”¨

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 2. å¤‡ä»½æ•°æ®åº“
./scripts/backup_database.sh

# 3. åœæ­¢æœåŠ¡
docker-compose down

# 4. é‡æ–°æ„å»ºé•œåƒ
docker-compose build --no-cache

# 5. å¯åŠ¨æœåŠ¡
docker-compose up -d

# 6. è¿è¡Œæ•°æ®åº“è¿ç§»
docker-compose exec api alembic upgrade head

# 7. éªŒè¯æœåŠ¡
curl http://localhost:8000/health/ready
```

#### 5.1.4 æ‰©å®¹Worker

```bash
# ä¸´æ—¶æ‰©å®¹ï¼ˆé‡å¯åå¤±æ•ˆï¼‰
docker-compose up -d --scale celery-worker=4

# æ°¸ä¹…æ‰©å®¹ï¼ˆä¿®æ”¹docker-compose.ymlï¼‰
# åœ¨celery-workeræœåŠ¡ä¸‹æ·»åŠ ï¼š
#   deploy:
#     replicas: 4

docker-compose up -d
```

### 5.2 æ•°æ®å¤‡ä»½

#### 5.2.1 æ•°æ®åº“å¤‡ä»½

**è‡ªåŠ¨å¤‡ä»½è„šæœ¬ï¼ˆscripts/backup_database.shï¼‰**ï¼š
```bash
#!/bin/bash

# é…ç½®
BACKUP_DIR="/backups"
DATE=$(date +%Y%m%d_%H%M%S)
FILENAME="notification_db_${DATE}.sql.gz"
KEEP_DAYS=7

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p ${BACKUP_DIR}

# æ‰§è¡Œå¤‡ä»½
echo "å¼€å§‹å¤‡ä»½æ•°æ®åº“..."
docker-compose exec -T postgres pg_dump -U notification_user notification_db | gzip > ${BACKUP_DIR}/${FILENAME}

# éªŒè¯å¤‡ä»½
if [ -f "${BACKUP_DIR}/${FILENAME}" ]; then
    echo "å¤‡ä»½æˆåŠŸ: ${FILENAME}"
    SIZE=$(ls -lh ${BACKUP_DIR}/${FILENAME} | awk '{print $5}')
    echo "å¤‡ä»½å¤§å°: ${SIZE}"
else
    echo "å¤‡ä»½å¤±è´¥ï¼"
    exit 1
fi

# æ¸…ç†æ—§å¤‡ä»½
echo "æ¸…ç†${KEEP_DAYS}å¤©å‰çš„å¤‡ä»½..."
find ${BACKUP_DIR} -name "notification_db_*.sql.gz" -type f -mtime +${KEEP_DAYS} -delete

echo "å¤‡ä»½å®Œæˆï¼"
```

**è®¾ç½®å®šæ—¶å¤‡ä»½ï¼ˆCrontabï¼‰**ï¼š
```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½ï¼‰
0 2 * * * /path/to/notification-platform/scripts/backup_database.sh >> /var/log/backup.log 2>&1
```

#### 5.2.2 æ•°æ®åº“æ¢å¤

```bash
# æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶
ls -lh /backups/notification_db_*.sql.gz

# æ¢å¤æ•°æ®åº“
gunzip < /backups/notification_db_20251024_020000.sql.gz | \
  docker-compose exec -T postgres psql -U notification_user notification_db

# éªŒè¯æ¢å¤
docker-compose exec postgres psql -U notification_user -d notification_db -c "\dt"
```

### 5.3 æ—¥å¿—ç®¡ç†

#### 5.3.1 æ—¥å¿—è½®è½¬é…ç½®

**/etc/logrotate.d/notification-platform**ï¼š
```
/var/log/notification-platform/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 0640 root root
    sharedscripts
    postrotate
        docker-compose restart api > /dev/null 2>&1 || true
    endscript
}
```

#### 5.3.2 æŸ¥çœ‹æ—¥å¿—

```bash
# å®æ—¶æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
docker-compose logs -f

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡æ—¥å¿—
docker-compose logs -f api

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
docker-compose logs api | grep ERROR

# å¯¼å‡ºæ—¥å¿—åˆ°æ–‡ä»¶
docker-compose logs --no-color > logs_$(date +%Y%m%d).txt
```

---

## å…­ã€ç›‘æ§å‘Šè­¦

### 6.1 Prometheusé…ç½®

**prometheus.yml**ï¼š
```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

scrape_configs:
  - job_name: 'notification-api'
    static_configs:
      - targets: ['api:8000']
    metrics_path: '/metrics'
    
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres-exporter:9187']
      
  - job_name: 'redis'
    static_configs:
      - targets: ['redis-exporter:9121']
```

### 6.2 Grafanaä»ªè¡¨æ¿

**å…³é”®ç›‘æ§æŒ‡æ ‡**ï¼š
- APIè¯·æ±‚é‡ï¼ˆQPSï¼‰
- APIå“åº”æ—¶é—´ï¼ˆP50/P95/P99ï¼‰
- æ¶ˆæ¯å‘é€æˆåŠŸç‡
- é˜Ÿåˆ—é•¿åº¦
- æ•°æ®åº“è¿æ¥æ•°
- ç³»ç»Ÿèµ„æºä½¿ç”¨ç‡

### 6.3 å‘Šè­¦è§„åˆ™

**alerts.yml**ï¼š
```yaml
groups:
  - name: notification_alerts
    rules:
      # APIå¯ç”¨æ€§å‘Šè­¦
      - alert: APIDown
        expr: up{job="notification-api"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "APIæœåŠ¡ä¸å¯ç”¨"
          description: "{{ $labels.instance }} APIæœåŠ¡å·²åœæ­¢"

      # æ¶ˆæ¯å‘é€å¤±è´¥ç‡å‘Šè­¦
      - alert: HighFailureRate
        expr: rate(messages_failed_total[5m]) / rate(messages_sent_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "æ¶ˆæ¯å‘é€å¤±è´¥ç‡è¿‡é«˜"
          description: "æœ€è¿‘5åˆ†é’Ÿå‘é€å¤±è´¥ç‡è¶…è¿‡5%"

      # é˜Ÿåˆ—å †ç§¯å‘Šè­¦
      - alert: QueueBacklog
        expr: rabbitmq_queue_messages > 1000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "æ¶ˆæ¯é˜Ÿåˆ—å †ç§¯"
          description: "é˜Ÿåˆ—æ¶ˆæ¯æ•°è¶…è¿‡1000æ¡"
```

---

## ä¸ƒã€æ•…éšœæ’æŸ¥

### 7.1 å¸¸è§é—®é¢˜è¯Šæ–­

#### 7.1.1 æœåŠ¡æ— æ³•å¯åŠ¨

**é—®é¢˜è¡¨ç°**ï¼š
```bash
docker-compose up -d
# å®¹å™¨ä¸æ–­é‡å¯
```

**æ’æŸ¥æ­¥éª¤**ï¼š
```bash
# 1. æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker-compose logs api

# 2. æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep 8000

# 3. æ£€æŸ¥é…ç½®æ–‡ä»¶
cat .env | grep -v "^#" | grep -v "^$"

# 4. æ£€æŸ¥ç£ç›˜ç©ºé—´
df -h

# 5. æ£€æŸ¥å†…å­˜
free -h
```

#### 7.1.2 æ•°æ®åº“è¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
sqlalchemy.exc.OperationalError: could not connect to server
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# 1. æ£€æŸ¥æ•°æ®åº“å®¹å™¨çŠ¶æ€
docker-compose ps postgres

# 2. æ£€æŸ¥æ•°æ®åº“æ—¥å¿—
docker-compose logs postgres

# 3. å°è¯•æ‰‹åŠ¨è¿æ¥
docker-compose exec postgres psql -U notification_user -d notification_db

# 4. æ£€æŸ¥ç½‘ç»œè¿æ¥
docker-compose exec api ping postgres

# 5. é‡å¯æ•°æ®åº“
docker-compose restart postgres
```

#### 7.1.3 é‚®ä»¶å‘é€å¤±è´¥

**æ’æŸ¥æ­¥éª¤**ï¼š
```bash
# 1. æŸ¥çœ‹Workeræ—¥å¿—
docker-compose logs celery-worker | grep ERROR

# 2. æ£€æŸ¥é‚®ç®±è´¦æˆ·çŠ¶æ€
docker-compose exec api python << EOF
from app.services.email_service import EmailPoolManager
pool = EmailPoolManager()
account = pool.get_available_account()
print(f"å¯ç”¨é‚®ç®±: {account.email if account else 'None'}")
EOF

# 3. æµ‹è¯•SMTPè¿æ¥
docker-compose exec api python << EOF
import smtplib
try:
    server = smtplib.SMTP_SSL('smtp.example.com', 465)
    server.login('user@example.com', 'password')
    print("SMTPè¿æ¥æˆåŠŸ")
    server.quit()
except Exception as e:
    print(f"SMTPè¿æ¥å¤±è´¥: {e}")
EOF

# 4. æ£€æŸ¥é‚®ç®±é…ç½®
docker-compose exec postgres psql -U notification_user -d notification_db -c \
  "SELECT email, is_active, daily_sent_count, daily_limit FROM email_accounts;"
```

### 7.2 æ€§èƒ½é—®é¢˜è¯Šæ–­

#### 7.2.1 APIå“åº”æ…¢

```bash
# 1. æŸ¥çœ‹æ…¢æŸ¥è¯¢
docker-compose exec postgres psql -U notification_user -d notification_db << EOF
SELECT query, mean_exec_time, calls
FROM pg_stat_statements
ORDER BY mean_exec_time DESC
LIMIT 10;
EOF

# 2. æŸ¥çœ‹æ•°æ®åº“è¿æ¥
docker-compose exec postgres psql -U notification_user -d notification_db -c \
  "SELECT count(*) FROM pg_stat_activity;"

# 3. æŸ¥çœ‹Rediså†…å­˜
docker-compose exec redis redis-cli INFO memory

# 4. æŸ¥çœ‹ç³»ç»Ÿèµ„æº
docker stats --no-stream
```

#### 7.2.2 å†…å­˜å ç”¨é«˜

```bash
# 1. æŸ¥çœ‹å®¹å™¨å†…å­˜ä½¿ç”¨
docker stats --no-stream | sort -k7 -h

# 2. ä¼˜åŒ–Workerå¹¶å‘æ•°
# ä¿®æ”¹docker-compose.ymlä¸­çš„--concurrencyå‚æ•°

# 3. å¢åŠ å†…å­˜é™åˆ¶
# åœ¨docker-compose.ymlä¸­æ·»åŠ :
#   deploy:
#     resources:
#       limits:
#         memory: 2G
```

---

## å…«ã€å¸¸è§é—®é¢˜

### 8.1 FAQ

#### Q1: å¦‚ä½•ä¿®æ”¹æ•°æ®åº“å¯†ç ï¼Ÿ

**A**: 
```bash
# 1. åœæ­¢æœåŠ¡
docker-compose down

# 2. ä¿®æ”¹.envæ–‡ä»¶ä¸­çš„DB_PASSWORD

# 3. åˆ é™¤æ•°æ®å·ï¼ˆæ³¨æ„ï¼šä¼šæ¸…ç©ºæ•°æ®ï¼‰
docker volume rm notification-platform_postgres_data

# 4. é‡æ–°å¯åŠ¨
docker-compose up -d

# å¦‚æœä¸æƒ³æ¸…ç©ºæ•°æ®ï¼Œéœ€è¦è¿›å…¥æ•°æ®åº“æ‰‹åŠ¨ä¿®æ”¹ï¼š
docker-compose exec postgres psql -U notification_user -d notification_db
ALTER USER notification_user WITH PASSWORD 'new_password';
```

#### Q2: å¦‚ä½•æŸ¥çœ‹å½“å‰ç³»ç»Ÿç‰ˆæœ¬ï¼Ÿ

**A**:
```bash
curl http://localhost:8000/api/v1/version
```

#### Q3: å¦‚ä½•æ¸…ç†æ—§æ•°æ®ï¼Ÿ

**A**:
```bash
# æ¸…ç†30å¤©å‰çš„æ¶ˆæ¯è®°å½•
docker-compose exec postgres psql -U notification_user -d notification_db << EOF
DELETE FROM message_records WHERE created_at < NOW() - INTERVAL '30 days';
EOF

# æ¸…ç†è¿‡æœŸé™„ä»¶
docker-compose exec api python scripts/cleanup_attachments.py
```

#### Q4: å¦‚ä½•ä¸´æ—¶ç¦ç”¨æŸä¸ªé‚®ç®±è´¦æˆ·ï¼Ÿ

**A**:
```bash
docker-compose exec postgres psql -U notification_user -d notification_db << EOF
UPDATE email_accounts SET is_active = false WHERE email = 'account@example.com';
EOF
```

#### Q5: å¦‚ä½•æ‰‹åŠ¨è§¦å‘æ•°æ®åº“å¤‡ä»½ï¼Ÿ

**A**:
```bash
./scripts/backup_database.sh
```

### 8.2 æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **æ•°æ®åº“ä¼˜åŒ–**ï¼š
   - å®šæœŸè¿è¡Œ`VACUUM ANALYZE`
   - æ·»åŠ é€‚å½“çš„ç´¢å¼•
   - å®šæœŸå½’æ¡£å†å²æ•°æ®

2. **Redisä¼˜åŒ–**ï¼š
   - è®¾ç½®maxmemory-policy
   - å®šæœŸæ¸…ç†è¿‡æœŸé”®

3. **åº”ç”¨ä¼˜åŒ–**ï¼š
   - å¢åŠ Workeræ•°é‡
   - ä½¿ç”¨è¿æ¥æ± 
   - å¯ç”¨Redisç¼“å­˜

4. **ç³»ç»Ÿä¼˜åŒ–**ï¼š
   - è°ƒæ•´å†…æ ¸å‚æ•°
   - ä½¿ç”¨SSDç¡¬ç›˜
   - å¢åŠ ç³»ç»Ÿå†…å­˜

---

## ä¹ã€åº”æ€¥é¢„æ¡ˆ

### 9.1 æœåŠ¡å®•æœº

**å¤„ç†æ­¥éª¤**ï¼š
1. ç¡®è®¤æ•…éšœèŒƒå›´
2. æŸ¥çœ‹ç›‘æ§å’Œæ—¥å¿—
3. å°è¯•é‡å¯æœåŠ¡
4. å¦‚æ— æ³•æ¢å¤ï¼Œå¯åŠ¨å¤‡ç”¨æœåŠ¡
5. é€šçŸ¥ç›¸å…³äººå‘˜

### 9.2 æ•°æ®åº“æ•…éšœ

**å¤„ç†æ­¥éª¤**ï¼š
1. ç«‹å³åœæ­¢å†™å…¥
2. ä»æœ€è¿‘å¤‡ä»½æ¢å¤
3. æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
4. é‡å¯æœåŠ¡

### 9.3 è”ç³»æ–¹å¼

| è§’è‰² | å§“å | ç”µè¯ | é‚®ç®± |
|------|------|------|------|
| è¿ç»´è´Ÿè´£äºº | å¼ ä¸‰ | 138xxxx | ops@example.com |
| å¼€å‘è´Ÿè´£äºº | æå›› | 139xxxx | dev@example.com |
| DBA | ç‹äº” | 137xxxx | dba@example.com |

---

## æ–‡æ¡£ç»“æŸ

æœ¬éƒ¨ç½²è¿ç»´æ‰‹å†Œå‚è€ƒé˜¿é‡Œäº‘è¿ç»´æœ€ä½³å®è·µç¼–å†™ï¼Œæ¶µç›–äº†æ¶ˆæ¯é€šçŸ¥å¹³å°çš„å®Œæ•´éƒ¨ç½²å’Œè¿ç»´æµç¨‹ã€‚

**ç‰ˆæœ¬æ›´æ–°è®°å½•**ï¼š
- v1.0 (2025-10-24)ï¼šåˆå§‹ç‰ˆæœ¬å‘å¸ƒ

**ç›¸å…³æ–‡æ¡£**ï¼š
- å¼€å‘è§„èŒƒæ‰‹å†Œ
- æ•°æ®åº“è®¾è®¡æ–‡æ¡£
- APIæ¥å£æ–‡æ¡£
- æ•…éšœå¤„ç†æ‰‹å†Œ

**æŠ€æœ¯æ”¯æŒ**ï¼š
- é‚®ç®±ï¼šsupport@example.com
- æ–‡æ¡£ï¼šhttps://docs.example.com
- Issueï¼šhttps://github.com/your-org/notification-platform/issues

