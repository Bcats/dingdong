# 模板使用指南

**版本**: 1.0  
**更新时间**: 2025-10-25

---

## 📋 什么是邮件模板？

邮件模板是预定义的邮件格式，支持动态变量替换。使用模板的好处：

- ✅ **统一格式** - 保持邮件风格一致
- ✅ **便于管理** - 集中管理和修改
- ✅ **支持变量** - 动态替换内容
- ✅ **版本控制** - 跟踪模板变更历史

---

## 🎨 模板语法

### 变量替换

使用 `{{variable_name}}` 语法插入变量：

```html
<p>尊敬的 {{username}}：</p>
<p>您的订单 {{order_id}} 已于 {{timestamp}} 发货。</p>
```

### 示例

**模板定义**:
```
主题: 订单通知 - {{order_id}}
内容: 
您好 {{username}}，
您的订单 {{order_id}} 已确认。
金额：¥{{amount}}
预计送达：{{delivery_date}}
```

**使用时传入变量**:
```json
{
  "template_code": "order_confirm",
  "template_variables": {
    "username": "张三",
    "order_id": "ORDER-12345",
    "amount": "99.00",
    "delivery_date": "2025-10-26"
  }
}
```

**实际发送的邮件**:
```
主题: 订单通知 - ORDER-12345
内容:
您好 张三，
您的订单 ORDER-12345 已确认。
金额：¥99.00
预计送达：2025-10-26
```

---

## 📝 创建模板

### API方式创建

**端点**: `POST /api/v1/templates`

**请求示例**:
```python
import requests

headers = {"Authorization": f"Bearer {token}"}

payload = {
    "code": "welcome_email",
    "name": "欢迎邮件",
    "channel": "email",
    "subject_template": "欢迎加入 - {{app_name}}",
    "content_template": """
    <html>
    <body>
        <h1>欢迎，{{username}}！</h1>
        <p>感谢您注册 {{app_name}}。</p>
        <p>您的账号：{{email}}</p>
        <p><a href="{{activation_link}}">点击激活账号</a></p>
    </body>
    </html>
    """,
    "content_type": "html",
    "description": "用户注册欢迎邮件"
}

response = requests.post(
    "http://localhost:8000/api/v1/templates",
    headers=headers,
    json=payload
)
```

---

## 📚 模板示例

### 1. 欢迎邮件

```html
<!-- 主题 -->
欢迎加入 {{app_name}}

<!-- 内容 -->
<html>
<body style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
    <div style="background-color: #4CAF50; color: white; padding: 20px; text-align: center;">
        <h1>欢迎加入！</h1>
    </div>
    <div style="padding: 20px;">
        <p>亲爱的 {{username}}：</p>
        <p>感谢您注册 {{app_name}}！</p>
        <p>您的账号信息：</p>
        <ul>
            <li>邮箱：{{email}}</li>
            <li>注册时间：{{register_time}}</li>
        </ul>
        <p style="text-align: center; margin: 30px 0;">
            <a href="{{activation_link}}" 
               style="background-color: #4CAF50; color: white; padding: 12px 30px; 
                      text-decoration: none; border-radius: 4px; display: inline-block;">
                激活账号
            </a>
        </p>
        <p style="color: #666; font-size: 12px;">
            如果按钮无法点击，请复制以下链接到浏览器：<br>
            {{activation_link}}
        </p>
    </div>
    <div style="background-color: #f1f1f1; padding: 10px; text-align: center; font-size: 12px;">
        <p>© 2025 {{app_name}}. All rights reserved.</p>
    </div>
</body>
</html>
```

**使用**:
```python
client.send_email(
    to=["newuser@example.com"],
    template_code="welcome_email",
    template_variables={
        "app_name": "我的应用",
        "username": "张三",
        "email": "newuser@example.com",
        "register_time": "2025-10-25 18:00:00",
        "activation_link": "https://example.com/activate?token=xxx"
    }
)
```

### 2. 订单确认

```html
<!-- 主题 -->
订单确认 - {{order_id}}

<!-- 内容 -->
<html>
<body style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
    <h2>订单确认</h2>
    <p>尊敬的 {{customer_name}}：</p>
    <p>您的订单已成功提交，详情如下：</p>
    
    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
        <tr style="background-color: #f5f5f5;">
            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">订单号</th>
            <td style="padding: 10px; border: 1px solid #ddd;">{{order_id}}</td>
        </tr>
        <tr>
            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">下单时间</th>
            <td style="padding: 10px; border: 1px solid #ddd;">{{order_time}}</td>
        </tr>
        <tr style="background-color: #f5f5f5;">
            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">订单金额</th>
            <td style="padding: 10px; border: 1px solid #ddd; color: #e74c3c; font-weight: bold;">
                ¥{{total_amount}}
            </td>
        </tr>
        <tr>
            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">收货地址</th>
            <td style="padding: 10px; border: 1px solid #ddd;">{{shipping_address}}</td>
        </tr>
    </table>
    
    <p>预计送达时间：{{estimated_delivery}}</p>
    <p>如有疑问，请联系客服。</p>
</body>
</html>
```

### 3. 密码重置

```html
<!-- 主题 -->
密码重置请求 - {{app_name}}

<!-- 内容 -->
<html>
<body style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
    <h2>密码重置</h2>
    <p>您好 {{username}}：</p>
    <p>我们收到了您的密码重置请求。</p>
    <p style="text-align: center; margin: 30px 0;">
        <a href="{{reset_link}}" 
           style="background-color: #3498db; color: white; padding: 12px 30px; 
                  text-decoration: none; border-radius: 4px; display: inline-block;">
            重置密码
        </a>
    </p>
    <p style="color: #e74c3c;">⚠️ 此链接将在 {{expire_hours}} 小时后失效。</p>
    <p style="color: #666; font-size: 12px;">
        如果这不是您的操作，请忽略此邮件。
    </p>
</body>
</html>
```

### 4. 报告通知

```html
<!-- 主题 -->
{{report_type}}报告 - {{date}}

<!-- 内容 -->
<html>
<body style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
    <h2>{{report_type}}报告</h2>
    <p>报告时间：{{date}}</p>
    
    <h3>关键指标</h3>
    <table style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background-color: #3498db; color: white;">
                <th style="padding: 10px; text-align: left;">指标</th>
                <th style="padding: 10px; text-align: right;">数值</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td style="padding: 10px; border: 1px solid #ddd;">用户数</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">
                    {{user_count}}
                </td>
            </tr>
            <tr style="background-color: #f5f5f5;">
                <td style="padding: 10px; border: 1px solid #ddd;">订单数</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">
                    {{order_count}}
                </td>
            </tr>
            <tr>
                <td style="padding: 10px; border: 1px solid #ddd;">总收入</td>
                <td style="padding: 10px; border: 1px solid #ddd; text-align: right; 
                           color: #27ae60; font-weight: bold;">
                    ¥{{total_revenue}}
                </td>
            </tr>
        </tbody>
    </table>
    
    <p style="margin-top: 20px;">
        详细报告请查看附件或访问 
        <a href="{{report_url}}">在线报告</a>
    </p>
</body>
</html>
```

---

## 🔧 模板管理

### 查询模板列表

```python
response = requests.get(
    "http://localhost:8000/api/v1/templates",
    headers=headers,
    params={"channel": "email", "page": 1, "page_size": 20}
)
```

### 查询单个模板

```python
template_id = 1
response = requests.get(
    f"http://localhost:8000/api/v1/templates/{template_id}",
    headers=headers
)
```

### 更新模板

```python
template_id = 1
payload = {
    "subject_template": "新的主题 - {{variable}}",
    "content_template": "新的内容...",
    "description": "更新说明"
}

response = requests.put(
    f"http://localhost:8000/api/v1/templates/{template_id}",
    headers=headers,
    json=payload
)
```

### 删除模板

```python
template_id = 1
response = requests.delete(
    f"http://localhost:8000/api/v1/templates/{template_id}",
    headers=headers
)
```

---

## ✅ 最佳实践

### 1. 命名规范

- **code**: 使用小写字母+下划线，如 `welcome_email`, `order_confirm`
- **name**: 使用清晰的中文名称，如 "欢迎邮件", "订单确认"

### 2. 变量命名

- 使用小写字母+下划线
- 语义化命名：`user_name`, `order_id`, `total_amount`
- 避免过于复杂的嵌套

### 3. HTML模板

- 使用内联样式（许多邮件客户端不支持`<style>`标签）
- 限制宽度在600px左右
- 使用表格布局（更好的兼容性）
- 提供纯文本链接备选

### 4. 测试

创建模板后务必测试：
```python
# 发送测试邮件
client.send_email(
    to=["test@example.com"],
    template_code="your_template",
    template_variables={
        "test_var": "test_value"
    }
)
```

### 5. 版本管理

- 重要修改前先备份
- 使用描述字段记录变更
- 查看历史版本（如果启用）

---

## 🎯 常见问题

### Q: 变量不替换怎么办？

**A**: 检查：
1. 变量名是否正确（区分大小写）
2. 是否使用了 `{{variable}}` 语法
3. `template_variables` 中是否包含该变量

### Q: HTML样式不生效？

**A**: 
- 使用内联样式而非外部CSS
- 避免使用复杂的CSS3特性
- 测试不同邮件客户端的显示

### Q: 如何处理可选变量？

**A**: 在应用层处理：
```python
variables = {
    "username": user.name,
    "optional_field": user.optional or "默认值"
}
```

---

## 📚 相关文档

- [快速开始指南](./快速开始指南.md)
- [API调用示例](./API调用示例.md)
- [API完整文档](http://localhost:8000/docs)

---

**文档版本**: 1.0  
**最后更新**: 2025-10-25

