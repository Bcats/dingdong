# å¿«é€Ÿå¼€å§‹æŒ‡å—

**ç‰ˆæœ¬**: 1.0  
**æ›´æ–°æ—¶é—´**: 2025-10-25  
**é€‚ç”¨å¯¹è±¡**: å¼€å‘è€…ã€ç³»ç»Ÿé›†æˆäººå‘˜

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿç®€ä»‹](#ç³»ç»Ÿç®€ä»‹)
2. [å‰ç½®æ¡ä»¶](#å‰ç½®æ¡ä»¶)
3. [è·å–APIå‡­è¯](#è·å–apiå‡­è¯)
4. [å‘é€ç¬¬ä¸€å°é‚®ä»¶](#å‘é€ç¬¬ä¸€å°é‚®ä»¶)
5. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸ¯ ç³»ç»Ÿç®€ä»‹

**æ¶ˆæ¯é€šçŸ¥å¹³å° (DingDong)** æ˜¯ä¸€ä¸ªç»Ÿä¸€çš„æ¶ˆæ¯é€šçŸ¥æœåŠ¡ï¼Œæ”¯æŒï¼š

- âœ… **é‚®ä»¶é€šçŸ¥** - SMTPé‚®ä»¶å‘é€
- ğŸ“± **çŸ­ä¿¡é€šçŸ¥** - (è§„åˆ’ä¸­)
- ğŸ’¬ **å³æ—¶æ¶ˆæ¯** - (è§„åˆ’ä¸­)

### æ ¸å¿ƒç‰¹æ€§

- ğŸš€ **å¼‚æ­¥å¤„ç†** - åŸºäºCeleryçš„å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—
- ğŸ“ **æ¨¡æ¿æ”¯æŒ** - æ”¯æŒåŠ¨æ€å˜é‡æ›¿æ¢
- ğŸ”„ **å¤±è´¥é‡è¯•** - è‡ªåŠ¨é‡è¯•æœºåˆ¶
- ğŸ“Š **ç›‘æ§é¢æ¿** - Flowerå®æ—¶ç›‘æ§
- ğŸ” **å®‰å…¨è®¤è¯** - API Key + JWT Token
- ğŸ“ˆ **é«˜å¯ç”¨** - Dockerå®¹å™¨åŒ–éƒ¨ç½²

---

## âœ… å‰ç½®æ¡ä»¶

### 1. ç³»ç»Ÿè¦æ±‚

- Docker 20.10+
- Docker Compose 2.0+
- ç½‘ç»œè¿æ¥ï¼ˆè®¿é—®SMTPæœåŠ¡å™¨ï¼‰

### 2. æœåŠ¡è®¿é—®åœ°å€

| æœåŠ¡ | åœ°å€ | è¯´æ˜ |
|------|------|------|
| APIæœåŠ¡ | http://localhost:8000 | ä¸»APIæœåŠ¡ |
| APIæ–‡æ¡£ | http://localhost:8000/docs | Swagger UI |
| Flowerç›‘æ§ | http://localhost:5555 | Celeryä»»åŠ¡ç›‘æ§ |
| RabbitMQç®¡ç† | http://localhost:15672 | æ¶ˆæ¯é˜Ÿåˆ—ç®¡ç† |

### 3. å¯åŠ¨æœåŠ¡

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd dingdong

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f api
```

---

## ğŸ”‘ è·å–APIå‡­è¯

### æ–¹å¼1: æ•°æ®åº“å·²æœ‰å‡­è¯ï¼ˆæ¨èç”¨äºæµ‹è¯•ï¼‰

å¦‚æœç³»ç»Ÿå·²åˆå§‹åŒ–ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æµ‹è¯•å‡­è¯ï¼š

```
API Key: noti_aL3rBP1SGm8yy4havWd0xK-nAZlBq5kgrIoI7SmOhy8
API Secret: secret_5vEh7qvot63UhMQ_qomUM8BfToW-hJ_q
```

### æ–¹å¼2: åˆ›å»ºæ–°çš„APIå‡­è¯

**ä½¿ç”¨åˆå§‹åŒ–è„šæœ¬**:
```bash
docker-compose exec api python scripts/init_api_key.py
```

**æ‰‹åŠ¨åˆ›å»º**:
```bash
# è¿›å…¥å®¹å™¨
docker-compose exec api bash

# å¯åŠ¨Python
python

# æ‰§è¡Œåˆ›å»ºä»£ç 
from app.core.database import SessionLocal
from app.models.api_key import APIKey
from app.core.security import generate_api_key, hash_api_secret
from datetime import datetime

db = SessionLocal()

api_key_str, api_secret_str = generate_api_key()
secret_hash = hash_api_secret(api_secret_str)

api_key = APIKey(
    api_key=api_key_str,
    secret_hash=secret_hash,
    name="my_app_key",
    is_active=True,
    created_at=datetime.now(),
    updated_at=datetime.now()
)

db.add(api_key)
db.commit()

print(f"API Key: {api_key_str}")
print(f"API Secret: {api_secret_str}")
print("è¯·ä¿å­˜è¿™äº›å‡­è¯ï¼")

db.close()
```

âš ï¸ **é‡è¦**: API Secretåªåœ¨åˆ›å»ºæ—¶æ˜¾ç¤ºä¸€æ¬¡ï¼Œè¯·å¦¥å–„ä¿å­˜ï¼

---

## ğŸ“§ å‘é€ç¬¬ä¸€å°é‚®ä»¶

### æ­¥éª¤1: è·å–è®¿é—®Token

**APIç«¯ç‚¹**: `POST /api/v1/auth/token`

**è¯·æ±‚ç¤ºä¾‹**:
```bash
curl -X POST http://localhost:8000/api/v1/auth/token \
  -H "Content-Type: application/json" \
  -d '{
    "api_key": "noti_aL3rBP1SGm8yy4havWd0xK-nAZlBq5kgrIoI7SmOhy8",
    "api_secret": "secret_5vEh7qvot63UhMQ_qomUM8BfToW-hJ_q"
  }'
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 0,
  "message": "Success",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "bearer",
    "expires_in": 3600
  }
}
```

**Pythonç¤ºä¾‹**:
```python
import requests

response = requests.post(
    "http://localhost:8000/api/v1/auth/token",
    json={
        "api_key": "noti_aL3rBP1SGm8yy4havWd0xK-nAZlBq5kgrIoI7SmOhy8",
        "api_secret": "secret_5vEh7qvot63UhMQ_qomUM8BfToW-hJ_q"
    }
)

token = response.json()["data"]["access_token"]
print(f"Token: {token}")
```

---

### æ­¥éª¤2: å‘é€é‚®ä»¶

**APIç«¯ç‚¹**: `POST /api/v1/messages/email/send`

**è¯·æ±‚å¤´**:
```
Authorization: Bearer <your_token>
Content-Type: application/json
```

**è¯·æ±‚ä½“**:
```json
{
  "to": ["user@example.com"],
  "subject": "æµ‹è¯•é‚®ä»¶",
  "content": "è¿™æ˜¯ä¸€å°æµ‹è¯•é‚®ä»¶",
  "content_type": "plain"
}
```

**å®Œæ•´ç¤ºä¾‹ (cURL)**:
```bash
curl -X POST http://localhost:8000/api/v1/messages/email/send \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "to": ["user@example.com"],
    "subject": "æµ‹è¯•é‚®ä»¶",
    "content": "è¿™æ˜¯ä¸€å°æµ‹è¯•é‚®ä»¶",
    "content_type": "plain"
  }'
```

**å®Œæ•´ç¤ºä¾‹ (Python)**:
```python
import requests

headers = {
    "Authorization": f"Bearer {token}",
    "Content-Type": "application/json"
}

payload = {
    "to": ["user@example.com"],
    "subject": "æµ‹è¯•é‚®ä»¶",
    "content": "è¿™æ˜¯ä¸€å°æµ‹è¯•é‚®ä»¶",
    "content_type": "plain"
}

response = requests.post(
    "http://localhost:8000/api/v1/messages/email/send",
    headers=headers,
    json=payload
)

result = response.json()
print(f"Message ID: {result['data']['message_id']}")
print(f"Status: {result['data']['status']}")
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "code": 0,
  "message": "Message queued for sending",
  "data": {
    "message_id": 123,
    "status": "pending",
    "request_id": "uuid-xxx-xxx"
  }
}
```

---

### æ­¥éª¤3: ä½¿ç”¨æ¨¡æ¿å‘é€

**å¥½å¤„**: 
- ç»Ÿä¸€é‚®ä»¶æ ¼å¼
- æ”¯æŒå˜é‡æ›¿æ¢
- ä¾¿äºç®¡ç†å’Œä¿®æ”¹

**è¯·æ±‚ä½“**:
```json
{
  "to": ["user@example.com"],
  "template_code": "test_email",
  "template_variables": {
    "timestamp": "2025-10-25 18:00:00"
  }
}
```

**å®Œæ•´ç¤ºä¾‹**:
```python
payload = {
    "to": ["user@example.com"],
    "template_code": "test_email",
    "template_variables": {
        "username": "å¼ ä¸‰",
        "order_id": "ORDER-12345",
        "amount": "99.00",
        "timestamp": "2025-10-25 18:00:00"
    }
}

response = requests.post(
    "http://localhost:8000/api/v1/messages/email/send",
    headers=headers,
    json=payload
)
```

---

## ğŸ¨ é«˜çº§åŠŸèƒ½

### 1. å‘é€HTMLé‚®ä»¶

```python
payload = {
    "to": ["user@example.com"],
    "subject": "æ¬¢è¿æ³¨å†Œ",
    "content": """
    <html>
    <body>
        <h1>æ¬¢è¿åŠ å…¥ï¼</h1>
        <p>å°Šæ•¬çš„ç”¨æˆ·ï¼Œæ„Ÿè°¢æ‚¨æ³¨å†Œæˆ‘ä»¬çš„æœåŠ¡ã€‚</p>
        <p><a href="https://example.com">ç‚¹å‡»è¿™é‡Œè®¿é—®</a></p>
    </body>
    </html>
    """,
    "content_type": "html"
}
```

### 2. å¤šæ”¶ä»¶äºº

```python
payload = {
    "to": [
        "user1@example.com",
        "user2@example.com",
        "user3@example.com"
    ],
    "subject": "ç¾¤å‘é€šçŸ¥",
    "content": "è¿™æ˜¯ä¸€å°ç¾¤å‘é‚®ä»¶"
}
```

### 3. æŠ„é€(CC)å’Œå¯†é€(BCC)

```python
payload = {
    "to": ["user@example.com"],
    "cc": ["manager@example.com"],
    "bcc": ["admin@example.com"],
    "subject": "é¡¹ç›®æŠ¥å‘Š",
    "content": "æœ¬å‘¨é¡¹ç›®è¿›å±•..."
}
```

### 4. å‘é€é™„ä»¶

```python
import base64

# è¯»å–æ–‡ä»¶å¹¶è½¬æ¢ä¸ºbase64
with open("report.pdf", "rb") as f:
    file_content = base64.b64encode(f.read()).decode()

payload = {
    "to": ["user@example.com"],
    "subject": "æŠ¥å‘Šæ–‡æ¡£",
    "content": "è¯·æŸ¥æ”¶é™„ä»¶ä¸­çš„æŠ¥å‘Š",
    "attachments": [
        {
            "filename": "report.pdf",
            "content": file_content
        }
    ]
}
```

---

## ğŸ” æŸ¥è¯¢æ¶ˆæ¯çŠ¶æ€

**APIç«¯ç‚¹**: `GET /api/v1/messages/{message_id}`

```python
message_id = 123

response = requests.get(
    f"http://localhost:8000/api/v1/messages/{message_id}",
    headers=headers
)

status = response.json()["data"]["status"]
print(f"æ¶ˆæ¯çŠ¶æ€: {status}")
```

**å¯èƒ½çš„çŠ¶æ€**:
- `pending` - å¾…å‘é€
- `sending` - å‘é€ä¸­
- `success` - å‘é€æˆåŠŸ
- `failed` - å‘é€å¤±è´¥
- `retrying` - é‡è¯•ä¸­

---

## ğŸ“Š ç›‘æ§

### Flowerç›‘æ§é¢æ¿

è®¿é—® http://localhost:5555 æŸ¥çœ‹ï¼š
- å®æ—¶ä»»åŠ¡çŠ¶æ€
- ä»»åŠ¡æ‰§è¡Œå†å²
- WorkerçŠ¶æ€
- ä»»åŠ¡æˆåŠŸç‡

**ç™»å½•å‡­è¯**:
- ç”¨æˆ·å: `admin`
- å¯†ç : `flower_dev_pass_2025`

### APIç›‘æ§æŒ‡æ ‡

```python
# è·å–ç³»ç»ŸæŒ‡æ ‡
response = requests.get(
    "http://localhost:8000/api/v1/monitoring/metrics?hours=24",
    headers=headers
)

metrics = response.json()["data"]
print(f"æˆåŠŸç‡: {metrics['messages']['success_rate']}%")
print(f"æ€»æ¶ˆæ¯: {metrics['messages']['total']}")
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: Tokenè¿‡æœŸæ€ä¹ˆåŠï¼Ÿ

**A**: Tokené»˜è®¤æœ‰æ•ˆæœŸ1å°æ—¶ï¼Œè¿‡æœŸåé‡æ–°è°ƒç”¨ `/api/v1/auth/token` è·å–æ–°Tokenã€‚

### Q2: é‚®ä»¶å‘é€å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A**: 
1. æ£€æŸ¥æ¶ˆæ¯çŠ¶æ€: `GET /api/v1/messages/{message_id}`
2. æŸ¥çœ‹é”™è¯¯ä¿¡æ¯: `error_message` å­—æ®µ
3. æŸ¥çœ‹æ—¥å¿—: `docker-compose logs celery-worker`
4. æŸ¥çœ‹Flowerç›‘æ§é¢æ¿

### Q3: å¦‚ä½•é…ç½®é‚®ç®±è´¦æˆ·ï¼Ÿ

**A**: éœ€è¦ç®¡ç†å‘˜æƒé™é…ç½®é‚®ç®±è´¦æˆ·ï¼Œè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜æˆ–å‚è€ƒéƒ¨ç½²æ–‡æ¡£ã€‚

### Q4: æ”¯æŒå“ªäº›é‚®ç®±æœåŠ¡å•†ï¼Ÿ

**A**: æ”¯æŒæ‰€æœ‰æ ‡å‡†SMTPæœåŠ¡ï¼ŒåŒ…æ‹¬ï¼š
- QQé‚®ç®±
- ç½‘æ˜“é‚®ç®±
- Gmail
- ä¼ä¸šé‚®ç®±
- é˜¿é‡Œäº‘é‚®ç®±

### Q5: æœ‰å‘é€é¢‘ç‡é™åˆ¶å—ï¼Ÿ

**A**: 
- å•ä¸ªé‚®ç®±è´¦æˆ·æœ‰æ¯æ—¥å‘é€é™é¢ï¼ˆå¯é…ç½®ï¼‰
- APIè°ƒç”¨æ— é™åˆ¶ï¼ˆå»ºè®®é…ç½®é€Ÿç‡é™åˆ¶ï¼‰
- ç³»ç»Ÿæ”¯æŒå¤šé‚®ç®±è´¦æˆ·è´Ÿè½½å‡è¡¡

### Q6: å¦‚ä½•æµ‹è¯•é‚®ä»¶åŠŸèƒ½ï¼Ÿ

**A**: 
```bash
# ä½¿ç”¨æµ‹è¯•è„šæœ¬
python scripts/test_email_advanced.py

# æˆ–ä½¿ç”¨Swagger UI
# è®¿é—® http://localhost:8000/docs
# åœ¨é¡µé¢ä¸Šç›´æ¥æµ‹è¯•API
```

---

## ğŸ“š ä¸‹ä¸€æ­¥

- é˜…è¯» [APIè°ƒç”¨ç¤ºä¾‹](./APIè°ƒç”¨ç¤ºä¾‹.md) - æ›´å¤šç¼–ç¨‹è¯­è¨€ç¤ºä¾‹
- é˜…è¯» [æ¨¡æ¿ä½¿ç”¨æŒ‡å—](./æ¨¡æ¿ä½¿ç”¨æŒ‡å—.md) - åˆ›å»ºå’Œç®¡ç†æ¨¡æ¿
- æŸ¥çœ‹ [APIæ–‡æ¡£](http://localhost:8000/docs) - å®Œæ•´APIå‚è€ƒ

---

## ğŸ†˜ è·å–å¸®åŠ©

- **é—®é¢˜åé¦ˆ**: æäº¤Issue
- **æŠ€æœ¯æ”¯æŒ**: support@example.com
- **æ–‡æ¡£ä¸­å¿ƒ**: http://docs.example.com

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-10-25  
**ç»´æŠ¤å›¢é˜Ÿ**: DingDongå¼€å‘å›¢é˜Ÿ

