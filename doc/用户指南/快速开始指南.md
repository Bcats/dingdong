# 快速开始指南

**版本**: 1.0  
**更新时间**: 2025-10-25  
**适用对象**: 开发者、系统集成人员

---

## 📋 目录

1. [系统简介](#系统简介)
2. [前置条件](#前置条件)
3. [获取API凭证](#获取api凭证)
4. [发送第一封邮件](#发送第一封邮件)
5. [常见问题](#常见问题)

---

## 🎯 系统简介

**消息通知平台 (DingDong)** 是一个统一的消息通知服务，支持：

- ✅ **邮件通知** - SMTP邮件发送
- 📱 **短信通知** - (规划中)
- 💬 **即时消息** - (规划中)

### 核心特性

- 🚀 **异步处理** - 基于Celery的异步任务队列
- 📝 **模板支持** - 支持动态变量替换
- 🔄 **失败重试** - 自动重试机制
- 📊 **监控面板** - Flower实时监控
- 🔐 **安全认证** - API Key + JWT Token
- 📈 **高可用** - Docker容器化部署

---

## ✅ 前置条件

### 1. 系统要求

- Docker 20.10+
- Docker Compose 2.0+
- 网络连接（访问SMTP服务器）

### 2. 服务访问地址

| 服务 | 地址 | 说明 |
|------|------|------|
| API服务 | http://localhost:8000 | 主API服务 |
| API文档 | http://localhost:8000/docs | Swagger UI |
| Flower监控 | http://localhost:5555 | Celery任务监控 |
| RabbitMQ管理 | http://localhost:15672 | 消息队列管理 |

### 3. 启动服务

```bash
# 克隆项目
git clone <repository-url>
cd dingdong

# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f api
```

---

## 🔑 获取API凭证

### 方式1: 数据库已有凭证（推荐用于测试）

如果系统已初始化，可以使用以下测试凭证：

```
API Key: noti_aL3rBP1SGm8yy4havWd0xK-nAZlBq5kgrIoI7SmOhy8
API Secret: secret_5vEh7qvot63UhMQ_qomUM8BfToW-hJ_q
```

### 方式2: 创建新的API凭证

**使用初始化脚本**:
```bash
docker-compose exec api python scripts/init_api_key.py
```

**手动创建**:
```bash
# 进入容器
docker-compose exec api bash

# 启动Python
python

# 执行创建代码
from app.core.database import SessionLocal
from app.models.api_key import APIKey
from app.core.security import generate_api_key, hash_api_secret
from datetime import datetime

db = SessionLocal()

api_key_str, api_secret_str = generate_api_key()
secret_hash = hash_api_secret(api_secret_str)

api_key = APIKey(
    api_key=api_key_str,
    secret_hash=secret_hash,
    name="my_app_key",
    is_active=True,
    created_at=datetime.now(),
    updated_at=datetime.now()
)

db.add(api_key)
db.commit()

print(f"API Key: {api_key_str}")
print(f"API Secret: {api_secret_str}")
print("请保存这些凭证！")

db.close()
```

⚠️ **重要**: API Secret只在创建时显示一次，请妥善保存！

---

## 📧 发送第一封邮件

### 步骤1: 获取访问Token

**API端点**: `POST /api/v1/auth/token`

**请求示例**:
```bash
curl -X POST http://localhost:8000/api/v1/auth/token \
  -H "Content-Type: application/json" \
  -d '{
    "api_key": "noti_aL3rBP1SGm8yy4havWd0xK-nAZlBq5kgrIoI7SmOhy8",
    "api_secret": "secret_5vEh7qvot63UhMQ_qomUM8BfToW-hJ_q"
  }'
```

**响应示例**:
```json
{
  "code": 0,
  "message": "Success",
  "data": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "bearer",
    "expires_in": 3600
  }
}
```

**Python示例**:
```python
import requests

response = requests.post(
    "http://localhost:8000/api/v1/auth/token",
    json={
        "api_key": "noti_aL3rBP1SGm8yy4havWd0xK-nAZlBq5kgrIoI7SmOhy8",
        "api_secret": "secret_5vEh7qvot63UhMQ_qomUM8BfToW-hJ_q"
    }
)

token = response.json()["data"]["access_token"]
print(f"Token: {token}")
```

---

### 步骤2: 发送邮件

**API端点**: `POST /api/v1/messages/email/send`

**请求头**:
```
Authorization: Bearer <your_token>
Content-Type: application/json
```

**请求体**:
```json
{
  "to": ["user@example.com"],
  "subject": "测试邮件",
  "content": "这是一封测试邮件",
  "content_type": "plain"
}
```

**完整示例 (cURL)**:
```bash
curl -X POST http://localhost:8000/api/v1/messages/email/send \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "to": ["user@example.com"],
    "subject": "测试邮件",
    "content": "这是一封测试邮件",
    "content_type": "plain"
  }'
```

**完整示例 (Python)**:
```python
import requests

headers = {
    "Authorization": f"Bearer {token}",
    "Content-Type": "application/json"
}

payload = {
    "to": ["user@example.com"],
    "subject": "测试邮件",
    "content": "这是一封测试邮件",
    "content_type": "plain"
}

response = requests.post(
    "http://localhost:8000/api/v1/messages/email/send",
    headers=headers,
    json=payload
)

result = response.json()
print(f"Message ID: {result['data']['message_id']}")
print(f"Status: {result['data']['status']}")
```

**响应示例**:
```json
{
  "code": 0,
  "message": "Message queued for sending",
  "data": {
    "message_id": 123,
    "status": "pending",
    "request_id": "uuid-xxx-xxx"
  }
}
```

---

### 步骤3: 使用模板发送

**好处**: 
- 统一邮件格式
- 支持变量替换
- 便于管理和修改

**请求体**:
```json
{
  "to": ["user@example.com"],
  "template_code": "test_email",
  "template_variables": {
    "timestamp": "2025-10-25 18:00:00"
  }
}
```

**完整示例**:
```python
payload = {
    "to": ["user@example.com"],
    "template_code": "test_email",
    "template_variables": {
        "username": "张三",
        "order_id": "ORDER-12345",
        "amount": "99.00",
        "timestamp": "2025-10-25 18:00:00"
    }
}

response = requests.post(
    "http://localhost:8000/api/v1/messages/email/send",
    headers=headers,
    json=payload
)
```

---

## 🎨 高级功能

### 1. 发送HTML邮件

```python
payload = {
    "to": ["user@example.com"],
    "subject": "欢迎注册",
    "content": """
    <html>
    <body>
        <h1>欢迎加入！</h1>
        <p>尊敬的用户，感谢您注册我们的服务。</p>
        <p><a href="https://example.com">点击这里访问</a></p>
    </body>
    </html>
    """,
    "content_type": "html"
}
```

### 2. 多收件人

```python
payload = {
    "to": [
        "user1@example.com",
        "user2@example.com",
        "user3@example.com"
    ],
    "subject": "群发通知",
    "content": "这是一封群发邮件"
}
```

### 3. 抄送(CC)和密送(BCC)

```python
payload = {
    "to": ["user@example.com"],
    "cc": ["manager@example.com"],
    "bcc": ["admin@example.com"],
    "subject": "项目报告",
    "content": "本周项目进展..."
}
```

### 4. 发送附件

```python
import base64

# 读取文件并转换为base64
with open("report.pdf", "rb") as f:
    file_content = base64.b64encode(f.read()).decode()

payload = {
    "to": ["user@example.com"],
    "subject": "报告文档",
    "content": "请查收附件中的报告",
    "attachments": [
        {
            "filename": "report.pdf",
            "content": file_content
        }
    ]
}
```

---

## 🔍 查询消息状态

**API端点**: `GET /api/v1/messages/{message_id}`

```python
message_id = 123

response = requests.get(
    f"http://localhost:8000/api/v1/messages/{message_id}",
    headers=headers
)

status = response.json()["data"]["status"]
print(f"消息状态: {status}")
```

**可能的状态**:
- `pending` - 待发送
- `sending` - 发送中
- `success` - 发送成功
- `failed` - 发送失败
- `retrying` - 重试中

---

## 📊 监控

### Flower监控面板

访问 http://localhost:5555 查看：
- 实时任务状态
- 任务执行历史
- Worker状态
- 任务成功率

**登录凭证**:
- 用户名: `admin`
- 密码: `flower_dev_pass_2025`

### API监控指标

```python
# 获取系统指标
response = requests.get(
    "http://localhost:8000/api/v1/monitoring/metrics?hours=24",
    headers=headers
)

metrics = response.json()["data"]
print(f"成功率: {metrics['messages']['success_rate']}%")
print(f"总消息: {metrics['messages']['total']}")
```

---

## ❓ 常见问题

### Q1: Token过期怎么办？

**A**: Token默认有效期1小时，过期后重新调用 `/api/v1/auth/token` 获取新Token。

### Q2: 邮件发送失败怎么办？

**A**: 
1. 检查消息状态: `GET /api/v1/messages/{message_id}`
2. 查看错误信息: `error_message` 字段
3. 查看日志: `docker-compose logs celery-worker`
4. 查看Flower监控面板

### Q3: 如何配置邮箱账户？

**A**: 需要管理员权限配置邮箱账户，请联系系统管理员或参考部署文档。

### Q4: 支持哪些邮箱服务商？

**A**: 支持所有标准SMTP服务，包括：
- QQ邮箱
- 网易邮箱
- Gmail
- 企业邮箱
- 阿里云邮箱

### Q5: 有发送频率限制吗？

**A**: 
- 单个邮箱账户有每日发送限额（可配置）
- API调用无限制（建议配置速率限制）
- 系统支持多邮箱账户负载均衡

### Q6: 如何测试邮件功能？

**A**: 
```bash
# 使用测试脚本
python scripts/test_email_advanced.py

# 或使用Swagger UI
# 访问 http://localhost:8000/docs
# 在页面上直接测试API
```

---

## 📚 下一步

- 阅读 [API调用示例](./API调用示例.md) - 更多编程语言示例
- 阅读 [模板使用指南](./模板使用指南.md) - 创建和管理模板
- 查看 [API文档](http://localhost:8000/docs) - 完整API参考

---

## 🆘 获取帮助

- **问题反馈**: 提交Issue
- **技术支持**: support@example.com
- **文档中心**: http://docs.example.com

---

**文档版本**: 1.0  
**最后更新**: 2025-10-25  
**维护团队**: DingDong开发团队

