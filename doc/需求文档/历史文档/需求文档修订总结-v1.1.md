# 需求文档修订总结 v1.1

**修订日期**：2025-10-24  
**修订人**：需求分析师  
**文档状态**：已完成

---

## 📋 修订概览

本次修订基于审阅报告中发现的问题，对需求文档进行了全面优化和完善，重点解决了**所有最高优先级问题**，并根据用户反馈将第一期开发范围调整为**聚焦邮件单一渠道**。

---

## 🎯 核心调整

### 1. **第一期范围调整**（重大变更）

**调整前**：
- 邮件发送功能
- 短信发送功能（阿里云）
- 消息模板管理
- 消息发送历史记录
- 消息发送失败重试机制

**调整后**：
- ✅ **仅保留邮件发送功能**
- ✅ 消息模板管理（仅邮件模板）
- ✅ 消息发送历史记录
- ✅ 消息发送失败重试机制
- ✅ **新增：消息去重机制**
- ✅ **新增：邮件附件管理**
- ✅ **新增：JWT Token认证**
- ✅ **新增：基础监控指标**

**调整原因**：
- 快速验证系统架构可行性
- MVP理念：聚焦单一渠道，快速迭代
- 降低第一期开发复杂度和风险
- 开发周期从2-3周缩短为2周

**短信、微信功能**：移至第二期实现

---

## 🔧 解决的最高优先级问题

### 问题1：邮箱池日发送计数重置机制 ✅

**解决方案**：
- 使用PostgreSQL触发器自动重置
- 在`email_accounts`表上创建`reset_daily_count_if_needed()`触发器
- 每次查询或更新时自动检查日期，如果不是当天则重置计数

```sql
CREATE TRIGGER trg_reset_daily_count
BEFORE SELECT OR UPDATE ON email_accounts
FOR EACH ROW
EXECUTE FUNCTION reset_daily_count_if_needed();
```

---

### 问题2：邮件发送接口参数冲突 ✅

**解决方案**：
- 明确两种发送模式：**直接发送**和**模板发送**
- `content` 和 `template_id` 二选一，不能同时提供
- 在API验证层进行参数互斥校验
- 文档中明确说明使用规则

---

### 问题3：API认证机制不完善 ✅

**解决方案**：
- 采用JWT Token认证机制
- 认证流程：
  1. 客户端使用API Key + API Secret获取JWT Token
  2. 后续请求携带Token
  3. Token有效期1小时，支持刷新
- 防止重放攻击
- API Secret使用bcrypt哈希存储

---

### 问题4：敏感信息加密方式未说明 ✅

**解决方案**：
- **对称加密**：AES-256-GCM（用于SMTP密码等可逆加密）
- **哈希**：bcrypt（用于API Secret等单向加密）
- **传输加密**：强制HTTPS（TLS 1.2+）
- 加密密钥通过环境变量配置

---

### 问题5：邮箱池切换策略不清晰 ✅

**解决方案**：
- 明确切换逻辑：
  1. 按优先级选择（priority字段，数字越大越优先）
  2. 同优先级下按已发送数量升序选择
  3. 发送成功后增加计数器
  4. 连续失败3次自动禁用
  5. 每天凌晨自动重置计数
- 新增字段：`failure_count`, `last_failure_at`

---

### 问题6：邮件附件存储方案 ✅

**解决方案**：
- 第一期使用**本地文件系统**存储（简化实现）
- 提供独立的附件上传接口：`POST /api/v1/attachments/upload`
- 客户端先上传附件获取`attachment_id`，再发送邮件时传入ID
- 存储路径：`/data/attachments/{date}/{uuid}.{ext}`
- 附件7天后自动清理
- 第二期迁移到MinIO或阿里云OSS

---

### 问题7：消息去重机制缺失 ✅

**解决方案**：
- **幂等键方式**（推荐）：
  - 客户端提供`idempotency_key`
  - 5分钟内重复请求返回缓存结果
- **内容指纹方式**（兜底）：
  - 生成内容指纹：`SHA256(recipient + subject + content_hash + time_window)`
  - 5分钟时间窗口，相同内容视为重复
- 使用Redis存储，TTL=5分钟

---

### 问题8：环境变量配置不完整 ✅

**解决方案**：
- 补充完整的`.env`配置清单
- 分类组织：数据库、Redis、RabbitMQ、应用、JWT、加密、SMTP、附件、Celery等
- 包含所有必要的配置项和默认值

---

## 📊 数据库设计优化

### 新增表

1. **message_template_history**：模板历史版本表
   - 支持模板版本管理和回滚
   - 记录每次修改的详细信息

2. **email_attachments**：邮件附件表
   - 存储附件元信息
   - 管理附件生命周期

### 表结构优化

**message_records表**：
- ✅ 添加`template_version`：记录使用的模板版本号
- ✅ 添加`retry_logs`：JSON格式记录每次重试的详细日志
- ✅ 添加`idempotency_key`：幂等键，防止重复发送
- ✅ 添加`request_id`：请求追踪ID，全链路追踪
- ✅ 添加外键约束：`template_id` -> `message_templates.id`

**message_templates表**：
- ✅ 添加`created_by`：创建人
- ✅ 添加`updated_by`：最后修改人
- ✅ 优化索引：`idx_is_active`, `idx_deleted_at`

**email_accounts表**：
- ✅ 添加`failure_count`：连续失败次数
- ✅ 添加`last_failure_at`：最后失败时间
- ✅ 优化索引：`idx_priority (priority DESC, daily_sent_count ASC)`
- ✅ 添加触发器：自动重置日发送计数

**api_keys表**：
- ✅ `api_secret_hash`：存储bcrypt哈希值，不存储明文
- ✅ 添加`last_used_at`：最后使用时间
- ✅ 添加`usage_count`：使用次数统计

### 数据库约束和注释

- ✅ 添加外键约束（保证数据一致性）
- ✅ 添加表和字段注释（`COMMENT ON`）
- ✅ 添加数据库触发器（邮箱计数自动重置）

---

## 🔌 接口设计完善

### 新增接口

1. **健康检查接口**：
   - `GET /health` - 简单健康检查
   - `GET /health/ready` - 就绪检查（含依赖服务）
   - `GET /health/live` - 存活检查
   - `GET /metrics` - Prometheus监控指标

2. **附件管理接口**：
   - `POST /api/v1/attachments/upload` - 附件上传

3. **模板版本管理接口**：
   - `GET /api/v1/templates/{id}/history` - 查询历史版本
   - `POST /api/v1/templates/{id}/rollback` - 回滚到指定版本
   - `POST /api/v1/templates/preview` - 模板预览

4. **消息批量查询接口**：
   - `POST /api/v1/messages/batch/query` - 批量查询消息状态

### 接口优化

- ✅ 明确邮件发送接口的两种模式（直接发送/模板发送）
- ✅ 添加参数互斥校验说明
- ✅ 所有接口添加`idempotency_key`支持
- ✅ 完善错误码定义（增加HTTP状态码映射）
- ✅ 统一响应格式（添加`request_id`和`timestamp`）

---

## 🔒 安全性增强

1. **认证加密**：
   - JWT Token认证机制
   - Token有效期1小时，支持刷新

2. **数据加密**：
   - AES-256-GCM加密敏感信息
   - bcrypt哈希API Secret
   - 加密密钥环境变量配置

3. **传输加密**：
   - 强制HTTPS（TLS 1.2+）
   - 数据库连接SSL/TLS加密

4. **安全防护**：
   - SQLAlchemy ORM防止SQL注入
   - HTML转义防止XSS攻击
   - 敏感日志信息脱敏

---

## 📝 可维护性提升

### 日志规范（重要）

- ✅ **日志格式**：JSON格式，便于采集和分析
- ✅ **日志级别**：DEBUG/INFO/WARNING/ERROR/CRITICAL使用规范
- ✅ **Request ID追踪**：全链路追踪（API -> Queue -> Worker）
- ✅ **敏感信息脱敏**：邮箱地址、密码、Token等
- ✅ **日志存储**：使用loguru，按天切割，保留30天

### 代码规范

- ✅ 遵循PEP8规范
- ✅ 使用Black格式化代码
- ✅ 使用Pylint/Flake8进行代码检查
- ✅ 代码注释覆盖率不低于30%

### 测试策略

- ✅ 单元测试覆盖率 ≥ 60%
- ✅ 核心功能必须有测试
- ✅ 使用pytest框架
- ✅ 集成测试覆盖主要业务流程

---

## 📚 文档完善

### 需求文档

- ✅ 更详细的开发计划（按天拆分任务）
- ✅ 完整的示例用例（包含完整使用流程）
- ✅ 详细的验收标准（功能、性能、质量、文档四个维度）
- ✅ 完整的requirements.txt（分类清晰，版本锁定）
- ✅ 术语表和更新日志

### 配套文档（待生成）

- [ ] 开发规范文档
- [ ] 数据库设计文档（ER图）
- [ ] API接口文档（OpenAPI格式）
- [ ] 部署运维手册

---

## 📅 开发计划优化

### 第一期（2周）

**第1周**：基础框架和核心功能
- Day 1-2：项目初始化
- Day 3-4：邮件发送核心功能
- Day 5：消息队列集成

**第2周**：完善功能和发布
- Day 1-2：模板和附件
- Day 3-4：认证、去重和重试
- Day 5：监控、测试和文档

### 验收检查清单

- 12项功能验收标准
- 4项性能验收标准
- 5项质量验收标准
- 5项文档验收标准

---

## 🎯 验收标准完善

### 功能验收（12项）

1. 环境部署
2. 邮件发送功能
3. 附件功能
4. 模板管理
5. 消息去重
6. 失败重试
7. 认证和鉴权
8. 消息查询
9. 监控和健康检查

### 性能验收（4项）

- API响应时间 P95 < 200ms
- 消息入队时间 < 100ms
- 支持50并发
- 邮件吞吐量 ≥ 100封/分钟

### 质量验收（5项）

- 单元测试覆盖率 ≥ 60%
- 所有测试通过
- 代码规范
- 无Critical安全漏洞

### 文档验收（5项）

- API文档完整
- 部署文档可执行
- README完整
- 数据库设计文档

---

## 📦 技术栈完善

### Python库更新

**新增**：
- `jinja2==3.1.2` - 模板引擎
- `email-validator==2.1.0` - 邮箱验证
- `prometheus-client==0.19.0` - 监控指标
- `flower==2.0.1` - Celery监控
- `pytest-cov==4.1.0` - 测试覆盖率
- `pytest-mock==3.12.0` - Mock测试

**移除**（移至第二期）：
- `aliyun-python-sdk-core` - 阿里云SDK
- `aliyun-python-sdk-dysmsapi` - 阿里云短信SDK

---

## 📊 影响范围评估

### 高影响变更

1. **第一期范围调整**：
   - 影响：开发计划、测试计划、部署计划
   - 收益：开发周期缩短、风险降低、交付更快

2. **JWT认证机制**：
   - 影响：客户端集成方式变更
   - 收益：安全性提升、符合行业标准

3. **消息去重机制**：
   - 影响：客户端可选提供幂等键
   - 收益：防止重复发送、提升可靠性

### 中等影响变更

1. **附件管理方式**：
   - 影响：客户端需先上传附件
   - 收益：性能提升、解耦附件和消息

2. **数据库表结构调整**：
   - 影响：需要执行数据库迁移脚本
   - 收益：数据完整性、功能完善

### 低影响变更

- 日志格式调整
- 环境变量增加
- 监控指标暴露

---

## ✅ 完成情况

### 已完成

- ✅ 第一期范围调整
- ✅ 解决所有8个最高优先级问题
- ✅ 数据库设计优化（2个新表、多个字段新增、外键约束、触发器）
- ✅ 接口设计完善（4个新接口、多个接口优化）
- ✅ 安全性增强（加密方案、JWT认证、脱敏规范）
- ✅ 可维护性提升（日志规范、代码规范、测试策略）
- ✅ 文档完善（开发计划、示例用例、验收标准、技术栈）
- ✅ 更新日志编写

### 待完成（下一步）

- [ ] 与技术团队评审修订后的需求文档
- [ ] 生成配套文档：
  - [ ] 开发规范文档
  - [ ] 数据库设计文档（ER图）
  - [ ] API接口文档（OpenAPI格式）
  - [ ] 部署运维手册
- [ ] 开始第一期开发工作

---

## 💡 建议

### 给开发团队

1. 优先阅读**第一期详细需求**（第3章）
2. 重点关注**数据库设计**（触发器、外键约束）
3. 仔细理解**邮箱池切换逻辑**和**消息去重机制**
4. 严格遵循**日志规范**和**代码规范**

### 给项目管理

1. 第一期聚焦邮件功能，确保按时交付
2. 短信、微信功能推迟至第二期，不影响整体规划
3. 验收标准明确，建议按清单逐项验收
4. 建议第一期结束后召开评审会，总结经验

### 给测试团队

1. 重点测试邮箱池切换逻辑（特别是失败自动禁用）
2. 重点测试消息去重机制（幂等键和内容指纹）
3. 重点测试失败重试机制（重试间隔和次数）
4. 性能测试目标：50并发，P95<200ms

---

## 📞 联系方式

如有任何疑问或需要进一步讨论，请随时反馈。

---

## 文档结束

**当前状态**：需求文档修订完成，等待评审  
**下一步**：生成配套文档（开发规范、数据库设计、API接口文档）  
**预计时间**：1-2小时


