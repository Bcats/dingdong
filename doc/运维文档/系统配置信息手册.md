# 系统配置信息手册

> **更新时间**: 2025-10-25  
> **适用环境**: 开发/生产环境  
> **⚠️ 安全提示**: 本文档包含敏感信息，请妥善保管，勿泄露给无关人员

---

## 📋 目录

1. [PostgreSQL数据库](#1-postgresql数据库)
2. [Redis缓存](#2-redis缓存)
3. [RabbitMQ消息队列](#3-rabbitmq消息队列)
4. [FastAPI应用](#4-fastapi应用)
5. [Celery任务队列](#5-celery任务队列)
6. [Flower监控](#6-flower监控)
7. [管理后台](#7-管理后台)
8. [数据库操作命令](#8-数据库操作命令)
9. [环境变量配置](#9-环境变量配置)

---

## 1. PostgreSQL数据库

### 连接信息

| 配置项 | 值 | 说明 |
|--------|-----|------|
| **容器名称** | `notification-db` | Docker容器名 |
| **镜像** | `postgres:14-alpine` | PostgreSQL版本 |
| **主机地址** | `localhost` / `notification-db` | 本地/容器内 |
| **端口** | `5432` | 对外映射端口 |
| **数据库名** | `notification_db` | 数据库名称 |
| **用户名** | `notification_user` | 数据库用户 |
| **密码** | `changeme` | 默认密码（建议修改） |
| **连接URL** | `postgresql://notification_user:changeme@localhost:5432/notification_db` | 完整连接字符串 |

### 连接命令

```bash
# 方式1：通过Docker容器连接
docker-compose exec postgres psql -U notification_user -d notification_db

# 方式2：从宿主机连接（需要安装psql客户端）
psql -h localhost -p 5432 -U notification_user -d notification_db

# 方式3：Python连接
from sqlalchemy import create_engine
engine = create_engine("postgresql://notification_user:changeme@localhost:5432/notification_db")
```

### 数据库表结构

主要数据表：
- `message_records` - 消息记录表
- `email_accounts` - 邮箱账号表
- `message_templates` - 消息模板表
- `message_template_history` - 模板历史表
- `api_keys` - API密钥表
- `admin_users` - 管理员用户表

### 备份与恢复

```bash
# 备份数据库
docker-compose exec postgres pg_dump -U notification_user notification_db > backup_$(date +%Y%m%d).sql

# 恢复数据库
docker-compose exec -T postgres psql -U notification_user -d notification_db < backup_20251025.sql
```

### 数据卷

- **容器内路径**: `/var/lib/postgresql/data`
- **数据卷名称**: `dingdong_postgres_data`
- **备份目录**: `./backups`（映射到容器的`/backups`）

---

## 2. Redis缓存

### 连接信息

| 配置项 | 值 | 说明 |
|--------|-----|------|
| **容器名称** | `notification-redis` | Docker容器名 |
| **镜像** | `redis:7-alpine` | Redis版本 |
| **主机地址** | `localhost` / `notification-redis` | 本地/容器内 |
| **端口** | `6379` | 对外映射端口 |
| **密码** | 无（默认） | 可通过`REDIS_PASSWORD`设置 |
| **连接URL** | `redis://localhost:6379/0` | 完整连接字符串 |
| **数据库编号** | `0` - API缓存<br>`1` - Celery结果 | 多个DB隔离 |

### 连接命令

```bash
# 通过Docker容器连接
docker-compose exec redis redis-cli

# 测试连接
docker-compose exec redis redis-cli ping
# 输出：PONG

# 查看所有键
docker-compose exec redis redis-cli KEYS "*"

# 查看数据库信息
docker-compose exec redis redis-cli INFO
```

### 常用操作

```bash
# 清空当前数据库
redis-cli FLUSHDB

# 清空所有数据库
redis-cli FLUSHALL

# 查看特定键
redis-cli GET "key_name"

# 设置键值
redis-cli SET "key_name" "value"

# 设置过期时间（秒）
redis-cli EXPIRE "key_name" 3600
```

### 数据卷

- **容器内路径**: `/data`
- **数据卷名称**: `dingdong_redis_data`
- **持久化**: AOF模式（`appendonly yes`）

---

## 3. RabbitMQ消息队列

### 连接信息

| 配置项 | 值 | 说明 |
|--------|-----|------|
| **容器名称** | `notification-rabbitmq` | Docker容器名 |
| **镜像** | `rabbitmq:3.11-management-alpine` | RabbitMQ版本 |
| **主机地址** | `localhost` / `notification-rabbitmq` | 本地/容器内 |
| **AMQP端口** | `5672` | 消息队列端口 |
| **管理界面端口** | `15672` | Web管理界面 |
| **用户名** | `admin` | 默认用户 |
| **密码** | `changeme` | 默认密码（建议修改） |
| **连接URL** | `amqp://admin:changeme@localhost:5672//` | 完整连接字符串 |
| **管理界面URL** | `http://localhost:15672` | Web管理地址 |

### 访问管理界面

1. 浏览器打开：`http://localhost:15672`
2. 用户名：`admin`
3. 密码：`changeme`

### 队列信息

主要队列：
- **默认队列**: Celery任务队列
- **死信队列**: 失败任务处理

### 常用命令

```bash
# 查看队列状态
docker-compose exec rabbitmq rabbitmqctl list_queues

# 查看连接
docker-compose exec rabbitmq rabbitmqctl list_connections

# 查看交换机
docker-compose exec rabbitmq rabbitmqctl list_exchanges

# 清空队列
docker-compose exec rabbitmq rabbitmqctl purge_queue queue_name
```

### 数据卷

- **容器内路径**: `/var/lib/rabbitmq`
- **数据卷名称**: `dingdong_rabbitmq_data`

---

## 4. FastAPI应用

### 服务信息

| 配置项 | 值 | 说明 |
|--------|-----|------|
| **容器名称** | `notification-api` | Docker容器名 |
| **主机地址** | `localhost` | 本地访问 |
| **端口** | `8000` | API服务端口 |
| **基础URL** | `http://localhost:8000` | API基础地址 |
| **文档URL** | `http://localhost:8000/docs` | Swagger文档 |
| **ReDoc URL** | `http://localhost:8000/redoc` | ReDoc文档 |
| **健康检查** | `http://localhost:8000/health` | 健康检查端点 |
| **Workers数量** | `4` | Uvicorn工作进程数 |

### API端点

主要API路径：
- `/api/v1/messages` - 消息管理
- `/api/v1/templates` - 模板管理
- `/api/v1/admin/email-accounts` - 邮箱账号管理
- `/api/v1/admin/auth` - 管理员认证
- `/api/v1/monitoring` - 系统监控

### 日志位置

- **容器内路径**: `/app/logs`
- **宿主机路径**: `./logs`

---

## 5. Celery任务队列

### Worker服务

| 配置项 | 值 | 说明 |
|--------|-----|------|
| **容器名称** | `notification-worker` | Docker容器名 |
| **并发数** | `4` | Worker并发数 |
| **任务超时** | `300秒` | 单个任务最大执行时间 |
| **日志级别** | `info` | 日志记录级别 |

### Beat定时任务

| 配置项 | 值 | 说明 |
|--------|-----|------|
| **容器名称** | `notification-beat` | Docker容器名 |
| **调度文件** | `celerybeat-schedule` | 定时任务调度数据库 |

### 常用命令

```bash
# 查看Worker状态
docker-compose exec celery-worker celery -A app.tasks.celery_app inspect active

# 查看定时任务
docker-compose exec celery-beat celery -A app.tasks.celery_app inspect scheduled

# 清空任务队列
docker-compose exec celery-worker celery -A app.tasks.celery_app purge

# 重启Worker
docker-compose restart celery-worker

# 重启Beat
docker-compose restart celery-beat
```

---

## 6. Flower监控

### 连接信息

| 配置项 | 值 | 说明 |
|--------|-----|------|
| **容器名称** | `notification-flower` | Docker容器名 |
| **端口** | `5555` | Web界面端口 |
| **访问URL** | `http://localhost:5555` | Flower管理界面 |
| **用户名** | `admin` | 默认用户 |
| **密码** | `flower_dev_pass_2025` | 当前密码 |

### 功能说明

- **任务监控**: 实时查看Celery任务执行状态
- **Worker管理**: 查看和管理Worker进程
- **任务统计**: 任务成功率、失败率统计
- **任务追踪**: 查看任务详细执行日志

### 数据持久化

- **容器内路径**: `/data/flower.db`
- **数据卷名称**: `dingdong_flower_data`

---

## 7. 管理后台

### 前端服务

| 配置项 | 值 | 说明 |
|--------|-----|------|
| **项目目录** | `./admin-frontend` | 前端项目路径 |
| **开发端口** | `8080` | Vite开发服务器端口 |
| **访问URL** | `http://localhost:8080` | 前端访问地址 |
| **API代理** | `/api -> http://localhost:8000/api` | API请求代理 |

### 管理员账号

| 配置项 | 值 | 说明 |
|--------|-----|------|
| **用户名** | `admin` | 默认管理员用户名 |
| **密码** | `admin123` | 默认密码（建议修改） |
| **邮箱** | `admin@example.com` | 管理员邮箱 |

### 启动命令

```bash
# 进入前端目录
cd admin-frontend

# 安装依赖（首次运行）
npm install

# 启动开发服务器
npm run dev

# 构建生产版本
npm run build
```

---

## 8. 数据库操作命令

### 快速连接

```bash
# 连接PostgreSQL
docker-compose exec postgres psql -U notification_user -d notification_db

# 连接Redis
docker-compose exec redis redis-cli

# 查看RabbitMQ队列
docker-compose exec rabbitmq rabbitmqctl list_queues
```

### 常用SQL查询

```sql
-- 查看所有消息记录
SELECT id, subject, status, created_at FROM message_records ORDER BY created_at DESC LIMIT 10;

-- 查看邮箱账号
SELECT id, email, smtp_host, smtp_port, is_active FROM email_accounts;

-- 查看消息统计
SELECT 
    status,
    COUNT(*) as count,
    DATE(created_at) as date
FROM message_records
GROUP BY status, DATE(created_at)
ORDER BY date DESC;

-- 查看今天的消息
SELECT * FROM message_records 
WHERE created_at >= CURRENT_DATE 
ORDER BY created_at DESC;

-- 修复时区问题（将UTC时间转为本地时间+8小时）
UPDATE message_records
SET 
    created_at = created_at + INTERVAL '8 hours',
    updated_at = updated_at + INTERVAL '8 hours',
    sent_at = CASE WHEN sent_at IS NOT NULL THEN sent_at + INTERVAL '8 hours' ELSE NULL END;

-- 查看管理员用户
SELECT id, username, nickname, email, is_active, last_login_at FROM admin_users;
```

### 数据库维护

```sql
-- 查看数据库大小
SELECT pg_size_pretty(pg_database_size('notification_db'));

-- 查看表大小
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- 清理旧数据（谨慎操作！）
DELETE FROM message_records WHERE created_at < NOW() - INTERVAL '30 days';

-- 分析表（优化查询性能）
ANALYZE message_records;

-- 重建索引
REINDEX TABLE message_records;
```

---

## 9. 环境变量配置

### 必需环境变量

在项目根目录创建 `.env` 文件，包含以下配置：

```bash
# ==================== 基础配置 ====================
ENV=development
DEBUG=false
LOG_LEVEL=INFO
TZ=Asia/Shanghai

# ==================== 应用配置 ====================
APP_NAME=notification-platform
APP_VERSION=1.0.0
SECRET_KEY=your-secret-key-change-me-in-production
ALLOWED_HOSTS=*

# ==================== 数据库配置 ====================
DATABASE_URL=postgresql://notification_user:changeme@postgres:5432/notification_db
DB_PASSWORD=changeme
DB_PORT=5432
DB_POOL_SIZE=5
DB_MAX_OVERFLOW=15
DB_POOL_TIMEOUT=30
DB_POOL_RECYCLE=3600
DB_ECHO=false

# ==================== Redis配置 ====================
REDIS_URL=redis://redis:6379/0
REDIS_PASSWORD=
REDIS_PORT=6379
REDIS_MAX_CONNECTIONS=50
REDIS_SOCKET_TIMEOUT=5
REDIS_SOCKET_CONNECT_TIMEOUT=5

# ==================== RabbitMQ配置 ====================
RABBITMQ_URL=amqp://admin:changeme@rabbitmq:5672//
RABBITMQ_USER=admin
RABBITMQ_PASSWORD=changeme
RABBITMQ_PORT=5672
RABBITMQ_MANAGEMENT_PORT=15672
RABBITMQ_PREFETCH_COUNT=10
RABBITMQ_HEARTBEAT=60

# ==================== JWT配置 ====================
JWT_SECRET_KEY=your-jwt-secret-key-change-me
JWT_ALGORITHM=HS256
JWT_EXPIRE_MINUTES=60
JWT_REFRESH_EXPIRE_DAYS=7

# ==================== 加密配置 ====================
# 生成方法: python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
ENCRYPTION_KEY=your-fernet-encryption-key-change-me

# ==================== SMTP配置 ====================
EMAIL_TIMEOUT=30
EMAIL_MAX_SIZE=20971520
EMAIL_USE_TLS=true

# ==================== 附件配置 ====================
ATTACHMENT_STORAGE_PATH=/data/attachments
ATTACHMENT_MAX_SIZE=10485760
ATTACHMENT_EXPIRE_DAYS=7

# ==================== Celery配置 ====================
CELERY_BROKER_URL=amqp://admin:changeme@rabbitmq:5672//
CELERY_RESULT_BACKEND=redis://redis:6379/1
CELERY_WORKER_CONCURRENCY=4
CELERY_TASK_TIME_LIMIT=300
CELERY_TASK_SOFT_TIME_LIMIT=270

# ==================== Flower配置 ====================
FLOWER_USER=admin
FLOWER_PASSWORD=flower_dev_pass_2025
FLOWER_PORT=5555

# ==================== API配置 ====================
API_PORT=8000
API_V1_PREFIX=/api/v1
CORS_ORIGINS=["http://localhost:3000","http://localhost:8080"]
WORKERS=4

# ==================== 监控配置 ====================
PROMETHEUS_ENABLED=true
METRICS_PORT=9090

# ==================== 限流配置 ====================
RATE_LIMIT_ENABLED=true
RATE_LIMIT_PER_MINUTE=100
```

### 生成加密密钥

```bash
# 生成Fernet加密密钥
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"

# 生成随机密钥
python -c "import secrets; print(secrets.token_urlsafe(32))"
```

---

## 10. Docker操作命令

### 服务管理

```bash
# 启动所有服务
docker-compose up -d

# 停止所有服务
docker-compose stop

# 重启所有服务
docker-compose restart

# 停止并删除容器
docker-compose down

# 查看服务状态
docker-compose ps

# 查看服务日志
docker-compose logs -f [service_name]

# 重启单个服务
docker-compose restart api
docker-compose restart celery-worker
docker-compose restart postgres
```

### 容器操作

```bash
# 进入容器
docker-compose exec api bash
docker-compose exec postgres bash

# 查看容器日志
docker-compose logs -f --tail=100 api

# 查看资源使用
docker stats notification-api notification-worker notification-db
```

### 数据卷管理

```bash
# 查看数据卷
docker volume ls | grep dingdong

# 查看数据卷详情
docker volume inspect dingdong_postgres_data

# 备份数据卷
docker run --rm -v dingdong_postgres_data:/data -v $(pwd):/backup alpine tar czf /backup/postgres_backup.tar.gz -C /data .

# 恢复数据卷
docker run --rm -v dingdong_postgres_data:/data -v $(pwd):/backup alpine tar xzf /backup/postgres_backup.tar.gz -C /data
```

---

## 11. 故障排查

### 服务无法启动

```bash
# 1. 查看服务状态
docker-compose ps

# 2. 查看错误日志
docker-compose logs [service_name]

# 3. 检查端口占用
netstat -ano | findstr "5432"
netstat -ano | findstr "6379"
netstat -ano | findstr "5672"
netstat -ano | findstr "8000"

# 4. 重启服务
docker-compose restart [service_name]
```

### 数据库连接失败

```bash
# 1. 检查数据库服务状态
docker-compose ps postgres

# 2. 测试数据库连接
docker-compose exec postgres pg_isready -U notification_user

# 3. 查看数据库日志
docker-compose logs postgres

# 4. 重启数据库
docker-compose restart postgres
```

### Redis连接失败

```bash
# 1. 测试Redis连接
docker-compose exec redis redis-cli ping

# 2. 查看Redis日志
docker-compose logs redis

# 3. 清空Redis缓存
docker-compose exec redis redis-cli FLUSHALL
```

---

## 12. 安全建议

### 🔒 生产环境必须修改的配置

1. **数据库密码**: `DB_PASSWORD`
2. **RabbitMQ密码**: `RABBITMQ_PASSWORD`
3. **Flower密码**: `FLOWER_PASSWORD`
4. **JWT密钥**: `JWT_SECRET_KEY`
5. **加密密钥**: `ENCRYPTION_KEY`
6. **应用密钥**: `SECRET_KEY`
7. **管理员密码**: 修改默认管理员密码

### 🛡️ 安全最佳实践

- ✅ 定期更换密码和密钥
- ✅ 使用强密码（包含大小写字母、数字、特殊字符）
- ✅ 限制数据库和Redis只允许本地访问
- ✅ 启用防火墙，只开放必要端口
- ✅ 定期备份数据库
- ✅ 监控异常登录和API调用
- ✅ 使用HTTPS（生产环境）

---

## 📞 联系方式

如有问题，请联系系统管理员。

---

**文档版本**: v1.0  
**最后更新**: 2025-10-25  
**维护人员**: DevOps团队

