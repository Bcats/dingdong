# 监控系统使用指南

**版本**: 1.0  
**更新时间**: 2025-10-25  
**适用对象**: 运维人员、开发人员

---

## 📊 监控系统概览

消息通知平台提供了多层次的监控系统，包括：

1. **服务健康监控** - Docker健康检查
2. **任务监控** - Flower可视化界面
3. **业务指标监控** - 自定义API端点
4. **日志监控** - 结构化日志系统

---

## 🔧 监控组件

### 1. Docker健康检查

**查看服务状态**:
```bash
docker-compose ps
```

**服务列表**:
| 服务 | 端口 | 健康检查 |
|------|------|---------|
| API | 8000 | `/health` 端点 |
| PostgreSQL | 5432 | pg_isready |
| Redis | 6379 | redis-cli ping |
| RabbitMQ | 5672, 15672 | rabbitmq-diagnostics |
| Celery Worker | - | celery inspect ping |
| Celery Beat | - | 检查schedule文件 |
| Flower | 5555 | /healthcheck 端点 |

**健康检查配置**:
- **interval**: 检查间隔（30-60秒）
- **timeout**: 超时时间（10秒）
- **retries**: 重试次数（3次）
- **start_period**: 启动宽限期（30-60秒）

---

### 2. Flower监控面板

**访问地址**: http://localhost:5555  
**登录凭证**: 
- 用户名: `admin`
- 密码: `flower_dev_pass_2025`

**功能**:
- ✅ 实时任务监控
- ✅ Worker状态查看
- ✅ 任务执行历史
- ✅ 任务成功/失败统计
- ✅ 任务执行时间分析
- ✅ Worker池状态

**关键指标**:
1. **Active Tasks** - 正在执行的任务数
2. **Processed** - 已处理任务总数
3. **Failed** - 失败任务数
4. **Success Rate** - 成功率
5. **Average Time** - 平均执行时间

**数据持久化**:
- Flower数据存储在Docker volume: `flower_data`
- 最多保留10000条任务记录
- 数据库文件: `/data/flower.db`

---

### 3. RabbitMQ管理界面

**访问地址**: http://localhost:15672  
**登录凭证**:
- 用户名: `admin`
- 密码: `admin123`

**监控内容**:
- ✅ 队列长度
- ✅ 消息速率
- ✅ 连接数
- ✅ 通道数
- ✅ 内存使用

---

### 4. 业务指标API

#### 4.1 系统指标

**端点**: `GET /api/v1/monitoring/metrics`

**参数**:
- `hours`: 统计时间范围（默认24小时）

**返回数据**:
```json
{
  "time_range_hours": 24,
  "generated_at": "2025-10-25T17:30:00",
  "messages": {
    "total": 150,
    "success": 145,
    "failed": 5,
    "success_rate": 96.67,
    "by_status": {
      "success": 145,
      "failed": 5
    },
    "by_channel": {
      "email": 150
    }
  },
  "email_accounts": {
    "total": 1,
    "active": 1,
    "daily_sent": 50,
    "daily_limit": 500,
    "usage_rate": 10.0
  },
  "queue": {
    "pending_tasks": 0
  },
  "top_errors": [
    {
      "error": "SMTP connection timeout",
      "count": 3
    }
  ]
}
```

**使用示例**:
```bash
# 获取最近24小时指标
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:8000/api/v1/monitoring/metrics

# 获取最近1小时指标
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:8000/api/v1/monitoring/metrics?hours=1
```

---

#### 4.2 详细健康检查

**端点**: `GET /api/v1/monitoring/health/detailed`

**返回数据**:
```json
{
  "status": "healthy",
  "timestamp": "2025-10-25T17:30:00",
  "components": {
    "database": {
      "status": "healthy",
      "message": "Database connection OK"
    },
    "redis": {
      "status": "healthy",
      "message": "Redis connection OK"
    },
    "email_accounts": {
      "status": "healthy",
      "message": "1 active email account(s)"
    }
  }
}
```

**状态说明**:
- `healthy`: 所有组件正常
- `degraded`: 部分组件异常，但核心功能可用
- `unhealthy`: 关键组件异常，系统不可用

---

#### 4.3 每小时统计

**端点**: `GET /api/v1/monitoring/stats/hourly`

**参数**:
- `hours`: 统计时间范围（默认24小时）

**返回数据**:
```json
{
  "time_range_hours": 24,
  "data_points": 24,
  "data": [
    {
      "hour": "2025-10-25T16:00:00",
      "total": 10,
      "success": 9,
      "failed": 1,
      "success_rate": 90.0
    }
  ]
}
```

---

### 5. 日志系统

#### 5.1 日志文件位置

**目录**: `./logs/`

**日志文件**:
```
logs/
├── app_2025-10-25.log          # 应用日志（所有级别）
├── error_2025-10-25.log        # 错误日志（ERROR级别）
├── business_2025-10-25.log     # 业务日志（关键操作）
└── access_2025-10-25.log       # 访问日志（API请求）
```

#### 5.2 日志级别

| 级别 | 说明 | 使用场景 |
|------|------|---------|
| DEBUG | 调试信息 | 开发环境详细追踪 |
| INFO | 一般信息 | 正常业务流程 |
| WARNING | 警告 | 潜在问题 |
| ERROR | 错误 | 需要关注的错误 |
| CRITICAL | 严重错误 | 系统级严重问题 |

#### 5.3 日志格式

**应用日志**:
```
2025-10-25 17:30:00.123 | INFO     | app.services.email_service:send:197 | Email sent successfully to ['user@example.com']
```

**业务日志**:
```
2025-10-25 17:30:00.123 | EMAIL_SENT | message_id=5 | to=user@example.com | status=success
```

**访问日志**:
```
2025-10-25 17:30:00.123 | POST /api/v1/messages/email/send | Status: 200 | Duration: 850ms
```

#### 5.4 日志轮转

- **轮转频率**: 每天00:00
- **保留时间**:
  - 应用日志: 30天
  - 错误日志: 60天
  - 业务日志: 90天
  - 访问日志: 30天
- **压缩**: 自动压缩旧日志为zip格式

#### 5.5 查看日志

**实时查看**:
```bash
# 查看应用日志
tail -f logs/app_$(date +%Y-%m-%d).log

# 查看错误日志
tail -f logs/error_$(date +%Y-%m-%d).log

# 查看业务日志
tail -f logs/business_$(date +%Y-%m-%d).log
```

**Docker日志**:
```bash
# 查看API日志
docker-compose logs -f api

# 查看Worker日志
docker-compose logs -f celery-worker

# 查看所有服务日志
docker-compose logs -f
```

**搜索日志**:
```bash
# 搜索错误
grep "ERROR" logs/app_2025-10-25.log

# 搜索特定消息ID
grep "message_id=5" logs/business_2025-10-25.log

# 统计错误次数
grep -c "ERROR" logs/app_2025-10-25.log
```

---

## 📈 关键监控指标

### 必须监控的指标

| 指标 | 阈值 | 告警级别 | 处理措施 |
|------|------|---------|---------|
| 邮件成功率 | < 95% | WARNING | 检查邮箱账户和SMTP配置 |
| 邮件成功率 | < 90% | CRITICAL | 立即检查，可能需要切换账户 |
| 队列积压 | > 1000 | WARNING | 增加Worker数量 |
| 队列积压 | > 5000 | CRITICAL | 紧急扩容 |
| Worker无响应 | - | CRITICAL | 重启Worker |
| 数据库连接失败 | - | CRITICAL | 检查数据库服务 |
| Redis连接失败 | - | WARNING | 检查Redis服务 |
| 磁盘使用率 | > 80% | WARNING | 清理旧日志 |
| 磁盘使用率 | > 90% | CRITICAL | 立即清理 |

---

## 🚨 告警配置建议

### 告警规则

```yaml
# 邮件发送失败率告警
- name: email_failure_rate_high
  condition: failure_rate > 10%
  duration: 10m
  severity: warning
  action: 通知运维团队

- name: email_failure_rate_critical
  condition: failure_rate > 20%
  duration: 5m
  severity: critical
  action: 立即通知并尝试自动恢复

# 队列积压告警
- name: queue_backlog_warning
  condition: queue_length > 1000
  duration: 5m
  severity: warning
  action: 通知运维团队考虑扩容

# Worker离线告警
- name: worker_offline
  condition: active_workers == 0
  duration: 2m
  severity: critical
  action: 自动重启Worker

# 数据库连接告警
- name: database_connection_failed
  condition: db_health == "unhealthy"
  duration: 1m
  severity: critical
  action: 立即通知DBA
```

---

## 🔧 故障排查

### 常见问题

#### 1. 邮件发送失败率高

**排查步骤**:
1. 查看错误日志: `tail -f logs/error_*.log`
2. 检查邮箱账户状态: 访问监控API
3. 查看Flower中的失败任务
4. 检查SMTP配置和授权码

**可能原因**:
- 邮箱授权码过期
- SMTP服务器问题
- 达到发送限额
- 网络问题

#### 2. 队列积压严重

**排查步骤**:
1. 检查Worker数量: `docker-compose ps celery-worker`
2. 查看Worker日志: `docker-compose logs celery-worker`
3. 检查RabbitMQ队列: http://localhost:15672

**解决方案**:
- 增加Worker并发数: 修改`.env`中的`CELERY_WORKER_CONCURRENCY`
- 增加Worker实例数: `docker-compose up -d --scale celery-worker=4`

#### 3. Worker无响应

**排查步骤**:
1. 检查Worker健康状态: `docker-compose ps`
2. 查看Worker日志: `docker-compose logs celery-worker --tail=100`
3. 尝试ping Worker: `docker-compose exec celery-worker celery -A app.tasks.celery_app inspect ping`

**解决方案**:
```bash
# 重启Worker
docker-compose restart celery-worker

# 如果仍有问题，重新构建
docker-compose up -d --build celery-worker
```

---

## 📊 监控最佳实践

### 1. 定期检查

- **每日**: 查看Flower面板，确认任务处理正常
- **每周**: 检查日志文件大小，清理过期日志
- **每月**: 回顾错误日志，优化系统配置

### 2. 性能基线

建立正常运行时的性能基线：
- 平均响应时间: 50-200ms
- 邮件发送成功率: 95%+
- 队列处理速度: 100-500条/分钟

### 3. 告警降噪

- 设置合理的阈值避免误报
- 使用持续时间过滤短暂波动
- 对不同严重级别使用不同通知渠道

---

## 🔗 相关资源

- **Flower文档**: https://flower.readthedocs.io/
- **Celery监控**: https://docs.celeryproject.org/en/stable/userguide/monitoring.html
- **RabbitMQ管理**: https://www.rabbitmq.com/management.html
- **Loguru文档**: https://loguru.readthedocs.io/

---

**文档维护**: AI Assistant  
**最后更新**: 2025-10-25 17:30  
**版本**: 1.0

