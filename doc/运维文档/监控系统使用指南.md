# ç›‘æ§ç³»ç»Ÿä½¿ç”¨æŒ‡å—

**ç‰ˆæœ¬**: 1.0  
**æ›´æ–°æ—¶é—´**: 2025-10-25  
**é€‚ç”¨å¯¹è±¡**: è¿ç»´äººå‘˜ã€å¼€å‘äººå‘˜

---

## ğŸ“Š ç›‘æ§ç³»ç»Ÿæ¦‚è§ˆ

æ¶ˆæ¯é€šçŸ¥å¹³å°æä¾›äº†å¤šå±‚æ¬¡çš„ç›‘æ§ç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š

1. **æœåŠ¡å¥åº·ç›‘æ§** - Dockerå¥åº·æ£€æŸ¥
2. **ä»»åŠ¡ç›‘æ§** - Flowerå¯è§†åŒ–ç•Œé¢
3. **ä¸šåŠ¡æŒ‡æ ‡ç›‘æ§** - è‡ªå®šä¹‰APIç«¯ç‚¹
4. **æ—¥å¿—ç›‘æ§** - ç»“æ„åŒ–æ—¥å¿—ç³»ç»Ÿ

---

## ğŸ”§ ç›‘æ§ç»„ä»¶

### 1. Dockerå¥åº·æ£€æŸ¥

**æŸ¥çœ‹æœåŠ¡çŠ¶æ€**:
```bash
docker-compose ps
```

**æœåŠ¡åˆ—è¡¨**:
| æœåŠ¡ | ç«¯å£ | å¥åº·æ£€æŸ¥ |
|------|------|---------|
| API | 8000 | `/health` ç«¯ç‚¹ |
| PostgreSQL | 5432 | pg_isready |
| Redis | 6379 | redis-cli ping |
| RabbitMQ | 5672, 15672 | rabbitmq-diagnostics |
| Celery Worker | - | celery inspect ping |
| Celery Beat | - | æ£€æŸ¥scheduleæ–‡ä»¶ |
| Flower | 5555 | /healthcheck ç«¯ç‚¹ |

**å¥åº·æ£€æŸ¥é…ç½®**:
- **interval**: æ£€æŸ¥é—´éš”ï¼ˆ30-60ç§’ï¼‰
- **timeout**: è¶…æ—¶æ—¶é—´ï¼ˆ10ç§’ï¼‰
- **retries**: é‡è¯•æ¬¡æ•°ï¼ˆ3æ¬¡ï¼‰
- **start_period**: å¯åŠ¨å®½é™æœŸï¼ˆ30-60ç§’ï¼‰

---

### 2. Flowerç›‘æ§é¢æ¿

**è®¿é—®åœ°å€**: http://localhost:5555  
**ç™»å½•å‡­è¯**: 
- ç”¨æˆ·å: `admin`
- å¯†ç : `flower_dev_pass_2025`

**åŠŸèƒ½**:
- âœ… å®æ—¶ä»»åŠ¡ç›‘æ§
- âœ… WorkerçŠ¶æ€æŸ¥çœ‹
- âœ… ä»»åŠ¡æ‰§è¡Œå†å²
- âœ… ä»»åŠ¡æˆåŠŸ/å¤±è´¥ç»Ÿè®¡
- âœ… ä»»åŠ¡æ‰§è¡Œæ—¶é—´åˆ†æ
- âœ… Workeræ± çŠ¶æ€

**å…³é”®æŒ‡æ ‡**:
1. **Active Tasks** - æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡æ•°
2. **Processed** - å·²å¤„ç†ä»»åŠ¡æ€»æ•°
3. **Failed** - å¤±è´¥ä»»åŠ¡æ•°
4. **Success Rate** - æˆåŠŸç‡
5. **Average Time** - å¹³å‡æ‰§è¡Œæ—¶é—´

**æ•°æ®æŒä¹…åŒ–**:
- Floweræ•°æ®å­˜å‚¨åœ¨Docker volume: `flower_data`
- æœ€å¤šä¿ç•™10000æ¡ä»»åŠ¡è®°å½•
- æ•°æ®åº“æ–‡ä»¶: `/data/flower.db`

---

### 3. RabbitMQç®¡ç†ç•Œé¢

**è®¿é—®åœ°å€**: http://localhost:15672  
**ç™»å½•å‡­è¯**:
- ç”¨æˆ·å: `admin`
- å¯†ç : `admin123`

**ç›‘æ§å†…å®¹**:
- âœ… é˜Ÿåˆ—é•¿åº¦
- âœ… æ¶ˆæ¯é€Ÿç‡
- âœ… è¿æ¥æ•°
- âœ… é€šé“æ•°
- âœ… å†…å­˜ä½¿ç”¨

---

### 4. ä¸šåŠ¡æŒ‡æ ‡API

#### 4.1 ç³»ç»ŸæŒ‡æ ‡

**ç«¯ç‚¹**: `GET /api/v1/monitoring/metrics`

**å‚æ•°**:
- `hours`: ç»Ÿè®¡æ—¶é—´èŒƒå›´ï¼ˆé»˜è®¤24å°æ—¶ï¼‰

**è¿”å›æ•°æ®**:
```json
{
  "time_range_hours": 24,
  "generated_at": "2025-10-25T17:30:00",
  "messages": {
    "total": 150,
    "success": 145,
    "failed": 5,
    "success_rate": 96.67,
    "by_status": {
      "success": 145,
      "failed": 5
    },
    "by_channel": {
      "email": 150
    }
  },
  "email_accounts": {
    "total": 1,
    "active": 1,
    "daily_sent": 50,
    "daily_limit": 500,
    "usage_rate": 10.0
  },
  "queue": {
    "pending_tasks": 0
  },
  "top_errors": [
    {
      "error": "SMTP connection timeout",
      "count": 3
    }
  ]
}
```

**ä½¿ç”¨ç¤ºä¾‹**:
```bash
# è·å–æœ€è¿‘24å°æ—¶æŒ‡æ ‡
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:8000/api/v1/monitoring/metrics

# è·å–æœ€è¿‘1å°æ—¶æŒ‡æ ‡
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:8000/api/v1/monitoring/metrics?hours=1
```

---

#### 4.2 è¯¦ç»†å¥åº·æ£€æŸ¥

**ç«¯ç‚¹**: `GET /api/v1/monitoring/health/detailed`

**è¿”å›æ•°æ®**:
```json
{
  "status": "healthy",
  "timestamp": "2025-10-25T17:30:00",
  "components": {
    "database": {
      "status": "healthy",
      "message": "Database connection OK"
    },
    "redis": {
      "status": "healthy",
      "message": "Redis connection OK"
    },
    "email_accounts": {
      "status": "healthy",
      "message": "1 active email account(s)"
    }
  }
}
```

**çŠ¶æ€è¯´æ˜**:
- `healthy`: æ‰€æœ‰ç»„ä»¶æ­£å¸¸
- `degraded`: éƒ¨åˆ†ç»„ä»¶å¼‚å¸¸ï¼Œä½†æ ¸å¿ƒåŠŸèƒ½å¯ç”¨
- `unhealthy`: å…³é”®ç»„ä»¶å¼‚å¸¸ï¼Œç³»ç»Ÿä¸å¯ç”¨

---

#### 4.3 æ¯å°æ—¶ç»Ÿè®¡

**ç«¯ç‚¹**: `GET /api/v1/monitoring/stats/hourly`

**å‚æ•°**:
- `hours`: ç»Ÿè®¡æ—¶é—´èŒƒå›´ï¼ˆé»˜è®¤24å°æ—¶ï¼‰

**è¿”å›æ•°æ®**:
```json
{
  "time_range_hours": 24,
  "data_points": 24,
  "data": [
    {
      "hour": "2025-10-25T16:00:00",
      "total": 10,
      "success": 9,
      "failed": 1,
      "success_rate": 90.0
    }
  ]
}
```

---

### 5. æ—¥å¿—ç³»ç»Ÿ

#### 5.1 æ—¥å¿—æ–‡ä»¶ä½ç½®

**ç›®å½•**: `./logs/`

**æ—¥å¿—æ–‡ä»¶**:
```
logs/
â”œâ”€â”€ app_2025-10-25.log          # åº”ç”¨æ—¥å¿—ï¼ˆæ‰€æœ‰çº§åˆ«ï¼‰
â”œâ”€â”€ error_2025-10-25.log        # é”™è¯¯æ—¥å¿—ï¼ˆERRORçº§åˆ«ï¼‰
â”œâ”€â”€ business_2025-10-25.log     # ä¸šåŠ¡æ—¥å¿—ï¼ˆå…³é”®æ“ä½œï¼‰
â””â”€â”€ access_2025-10-25.log       # è®¿é—®æ—¥å¿—ï¼ˆAPIè¯·æ±‚ï¼‰
```

#### 5.2 æ—¥å¿—çº§åˆ«

| çº§åˆ« | è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|------|------|---------|
| DEBUG | è°ƒè¯•ä¿¡æ¯ | å¼€å‘ç¯å¢ƒè¯¦ç»†è¿½è¸ª |
| INFO | ä¸€èˆ¬ä¿¡æ¯ | æ­£å¸¸ä¸šåŠ¡æµç¨‹ |
| WARNING | è­¦å‘Š | æ½œåœ¨é—®é¢˜ |
| ERROR | é”™è¯¯ | éœ€è¦å…³æ³¨çš„é”™è¯¯ |
| CRITICAL | ä¸¥é‡é”™è¯¯ | ç³»ç»Ÿçº§ä¸¥é‡é—®é¢˜ |

#### 5.3 æ—¥å¿—æ ¼å¼

**åº”ç”¨æ—¥å¿—**:
```
2025-10-25 17:30:00.123 | INFO     | app.services.email_service:send:197 | Email sent successfully to ['user@example.com']
```

**ä¸šåŠ¡æ—¥å¿—**:
```
2025-10-25 17:30:00.123 | EMAIL_SENT | message_id=5 | to=user@example.com | status=success
```

**è®¿é—®æ—¥å¿—**:
```
2025-10-25 17:30:00.123 | POST /api/v1/messages/email/send | Status: 200 | Duration: 850ms
```

#### 5.4 æ—¥å¿—è½®è½¬

- **è½®è½¬é¢‘ç‡**: æ¯å¤©00:00
- **ä¿ç•™æ—¶é—´**:
  - åº”ç”¨æ—¥å¿—: 30å¤©
  - é”™è¯¯æ—¥å¿—: 60å¤©
  - ä¸šåŠ¡æ—¥å¿—: 90å¤©
  - è®¿é—®æ—¥å¿—: 30å¤©
- **å‹ç¼©**: è‡ªåŠ¨å‹ç¼©æ—§æ—¥å¿—ä¸ºzipæ ¼å¼

#### 5.5 æŸ¥çœ‹æ—¥å¿—

**å®æ—¶æŸ¥çœ‹**:
```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f logs/app_$(date +%Y-%m-%d).log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
tail -f logs/error_$(date +%Y-%m-%d).log

# æŸ¥çœ‹ä¸šåŠ¡æ—¥å¿—
tail -f logs/business_$(date +%Y-%m-%d).log
```

**Dockeræ—¥å¿—**:
```bash
# æŸ¥çœ‹APIæ—¥å¿—
docker-compose logs -f api

# æŸ¥çœ‹Workeræ—¥å¿—
docker-compose logs -f celery-worker

# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs -f
```

**æœç´¢æ—¥å¿—**:
```bash
# æœç´¢é”™è¯¯
grep "ERROR" logs/app_2025-10-25.log

# æœç´¢ç‰¹å®šæ¶ˆæ¯ID
grep "message_id=5" logs/business_2025-10-25.log

# ç»Ÿè®¡é”™è¯¯æ¬¡æ•°
grep -c "ERROR" logs/app_2025-10-25.log
```

---

## ğŸ“ˆ å…³é”®ç›‘æ§æŒ‡æ ‡

### å¿…é¡»ç›‘æ§çš„æŒ‡æ ‡

| æŒ‡æ ‡ | é˜ˆå€¼ | å‘Šè­¦çº§åˆ« | å¤„ç†æªæ–½ |
|------|------|---------|---------|
| é‚®ä»¶æˆåŠŸç‡ | < 95% | WARNING | æ£€æŸ¥é‚®ç®±è´¦æˆ·å’ŒSMTPé…ç½® |
| é‚®ä»¶æˆåŠŸç‡ | < 90% | CRITICAL | ç«‹å³æ£€æŸ¥ï¼Œå¯èƒ½éœ€è¦åˆ‡æ¢è´¦æˆ· |
| é˜Ÿåˆ—ç§¯å‹ | > 1000 | WARNING | å¢åŠ Workeræ•°é‡ |
| é˜Ÿåˆ—ç§¯å‹ | > 5000 | CRITICAL | ç´§æ€¥æ‰©å®¹ |
| Workeræ— å“åº” | - | CRITICAL | é‡å¯Worker |
| æ•°æ®åº“è¿æ¥å¤±è´¥ | - | CRITICAL | æ£€æŸ¥æ•°æ®åº“æœåŠ¡ |
| Redisè¿æ¥å¤±è´¥ | - | WARNING | æ£€æŸ¥RedisæœåŠ¡ |
| ç£ç›˜ä½¿ç”¨ç‡ | > 80% | WARNING | æ¸…ç†æ—§æ—¥å¿— |
| ç£ç›˜ä½¿ç”¨ç‡ | > 90% | CRITICAL | ç«‹å³æ¸…ç† |

---

## ğŸš¨ å‘Šè­¦é…ç½®å»ºè®®

### å‘Šè­¦è§„åˆ™

```yaml
# é‚®ä»¶å‘é€å¤±è´¥ç‡å‘Šè­¦
- name: email_failure_rate_high
  condition: failure_rate > 10%
  duration: 10m
  severity: warning
  action: é€šçŸ¥è¿ç»´å›¢é˜Ÿ

- name: email_failure_rate_critical
  condition: failure_rate > 20%
  duration: 5m
  severity: critical
  action: ç«‹å³é€šçŸ¥å¹¶å°è¯•è‡ªåŠ¨æ¢å¤

# é˜Ÿåˆ—ç§¯å‹å‘Šè­¦
- name: queue_backlog_warning
  condition: queue_length > 1000
  duration: 5m
  severity: warning
  action: é€šçŸ¥è¿ç»´å›¢é˜Ÿè€ƒè™‘æ‰©å®¹

# Workerç¦»çº¿å‘Šè­¦
- name: worker_offline
  condition: active_workers == 0
  duration: 2m
  severity: critical
  action: è‡ªåŠ¨é‡å¯Worker

# æ•°æ®åº“è¿æ¥å‘Šè­¦
- name: database_connection_failed
  condition: db_health == "unhealthy"
  duration: 1m
  severity: critical
  action: ç«‹å³é€šçŸ¥DBA
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. é‚®ä»¶å‘é€å¤±è´¥ç‡é«˜

**æ’æŸ¥æ­¥éª¤**:
1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—: `tail -f logs/error_*.log`
2. æ£€æŸ¥é‚®ç®±è´¦æˆ·çŠ¶æ€: è®¿é—®ç›‘æ§API
3. æŸ¥çœ‹Flowerä¸­çš„å¤±è´¥ä»»åŠ¡
4. æ£€æŸ¥SMTPé…ç½®å’Œæˆæƒç 

**å¯èƒ½åŸå› **:
- é‚®ç®±æˆæƒç è¿‡æœŸ
- SMTPæœåŠ¡å™¨é—®é¢˜
- è¾¾åˆ°å‘é€é™é¢
- ç½‘ç»œé—®é¢˜

#### 2. é˜Ÿåˆ—ç§¯å‹ä¸¥é‡

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥Workeræ•°é‡: `docker-compose ps celery-worker`
2. æŸ¥çœ‹Workeræ—¥å¿—: `docker-compose logs celery-worker`
3. æ£€æŸ¥RabbitMQé˜Ÿåˆ—: http://localhost:15672

**è§£å†³æ–¹æ¡ˆ**:
- å¢åŠ Workerå¹¶å‘æ•°: ä¿®æ”¹`.env`ä¸­çš„`CELERY_WORKER_CONCURRENCY`
- å¢åŠ Workerå®ä¾‹æ•°: `docker-compose up -d --scale celery-worker=4`

#### 3. Workeræ— å“åº”

**æ’æŸ¥æ­¥éª¤**:
1. æ£€æŸ¥Workerå¥åº·çŠ¶æ€: `docker-compose ps`
2. æŸ¥çœ‹Workeræ—¥å¿—: `docker-compose logs celery-worker --tail=100`
3. å°è¯•ping Worker: `docker-compose exec celery-worker celery -A app.tasks.celery_app inspect ping`

**è§£å†³æ–¹æ¡ˆ**:
```bash
# é‡å¯Worker
docker-compose restart celery-worker

# å¦‚æœä»æœ‰é—®é¢˜ï¼Œé‡æ–°æ„å»º
docker-compose up -d --build celery-worker
```

---

## ğŸ“Š ç›‘æ§æœ€ä½³å®è·µ

### 1. å®šæœŸæ£€æŸ¥

- **æ¯æ—¥**: æŸ¥çœ‹Floweré¢æ¿ï¼Œç¡®è®¤ä»»åŠ¡å¤„ç†æ­£å¸¸
- **æ¯å‘¨**: æ£€æŸ¥æ—¥å¿—æ–‡ä»¶å¤§å°ï¼Œæ¸…ç†è¿‡æœŸæ—¥å¿—
- **æ¯æœˆ**: å›é¡¾é”™è¯¯æ—¥å¿—ï¼Œä¼˜åŒ–ç³»ç»Ÿé…ç½®

### 2. æ€§èƒ½åŸºçº¿

å»ºç«‹æ­£å¸¸è¿è¡Œæ—¶çš„æ€§èƒ½åŸºçº¿ï¼š
- å¹³å‡å“åº”æ—¶é—´: 50-200ms
- é‚®ä»¶å‘é€æˆåŠŸç‡: 95%+
- é˜Ÿåˆ—å¤„ç†é€Ÿåº¦: 100-500æ¡/åˆ†é’Ÿ

### 3. å‘Šè­¦é™å™ª

- è®¾ç½®åˆç†çš„é˜ˆå€¼é¿å…è¯¯æŠ¥
- ä½¿ç”¨æŒç»­æ—¶é—´è¿‡æ»¤çŸ­æš‚æ³¢åŠ¨
- å¯¹ä¸åŒä¸¥é‡çº§åˆ«ä½¿ç”¨ä¸åŒé€šçŸ¥æ¸ é“

---

## ğŸ”— ç›¸å…³èµ„æº

- **Floweræ–‡æ¡£**: https://flower.readthedocs.io/
- **Celeryç›‘æ§**: https://docs.celeryproject.org/en/stable/userguide/monitoring.html
- **RabbitMQç®¡ç†**: https://www.rabbitmq.com/management.html
- **Loguruæ–‡æ¡£**: https://loguru.readthedocs.io/

---

**æ–‡æ¡£ç»´æŠ¤**: AI Assistant  
**æœ€åæ›´æ–°**: 2025-10-25 17:30  
**ç‰ˆæœ¬**: 1.0

